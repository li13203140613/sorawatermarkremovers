# 管理后台设置指南

## 📋 功能概览

管理后台提供以下功能：
- 📊 实时统计数据（用户数、处理次数、成功率等）
- 👥 用户列表管理（查看所有用户及其积分使用情况）
- 📝 操作日志（记录每次视频处理的详细信息）
- 🔍 筛选功能（按用户、状态、时间筛选日志）

---

## 🚀 快速开始

### 1. 创建数据库表

登录 [Supabase Dashboard](https://supabase.com/dashboard)：

1. 选择你的项目
2. 进入 **SQL Editor**
3. 执行以下 SQL：

```sql
-- 将 supabase/migrations/create_usage_logs.sql 中的内容粘贴到这里
```

或者直接复制 `supabase/migrations/create_usage_logs.sql` 文件的内容并执行。

### 2. 配置管理员邮箱

已配置：
```env
ADMIN_EMAIL=595386830@qq.com
```

⚠️ **重要**: 只有这个邮箱登录后才能访问管理后台！

### 3. 重启开发服务器

```bash
pnpm run dev
```

### 4. 访问后台

1. 使用管理员邮箱 `595386830@qq.com` 登录网站
2. 访问: `http://localhost:3000/admin`

如果不是管理员邮箱，访问 `/admin` 会返回 403 错误并重定向到首页。

---

## 📊 后台功能详解

### 统计卡片

显示关键指标：
- **总用户数**: 注册用户总数
- **今日处理次数**: 过去 24 小时的视频处理次数
- **成功率**: 所有时间的处理成功率（百分比）
- **7天活跃用户**: 过去 7 天有使用记录的用户数

### 操作日志

记录每次视频处理的详细信息：

| 字段 | 说明 |
|------|------|
| 时间 | 处理时间 |
| 用户 | 用户邮箱 + 剩余积分 |
| 原始链接 | 用户提交的视频链接（可点击） |
| 生成链接 | 处理后的视频链接（可点击） |
| 积分 | 消耗的积分数 |
| 状态 | 成功/失败（失败时悬停可查看错误信息） |

#### 筛选功能

- **用户搜索**: 输入邮箱关键词搜索
- **状态筛选**: 全部 / 成功 / 失败
- **时间范围**: 今日 / 7天 / 30天

#### 分页

- 每页显示 50 条记录
- 支持上一页/下一页导航

### 用户列表

查看所有注册用户及其使用情况：

| 字段 | 说明 |
|------|------|
| 用户邮箱 | 邮箱 + 用户 ID |
| 剩余积分 | 颜色标识（绿色>10, 黄色>0, 红色=0） |
| 总使用次数 | 累计处理视频次数 |
| 最后使用 | 最近一次使用时间（相对时间） |

---

## 🔧 技术实现

### 目录结构

```
app/
├── admin/                      # 管理后台页面
│   └── page.tsx               # 主页面
├── api/
│   └── admin/                 # 管理后台 API
│       ├── stats/route.ts     # 统计数据
│       ├── users/route.ts     # 用户列表
│       └── logs/route.ts      # 操作日志

components/
└── admin/                     # 管理后台组件
    ├── StatsCards.tsx         # 统计卡片
    ├── UsersTable.tsx         # 用户表格
    ├── LogsTable.tsx          # 日志表格
    └── LogsFilter.tsx         # 筛选器

lib/
└── admin/                     # 管理后台逻辑
    ├── types.ts               # 类型定义
    ├── queries.ts             # 数据库查询
    ├── logger.ts              # 日志记录
    ├── auth.ts                # 认证中间件
    └── index.ts               # 导出

supabase/
└── migrations/
    └── create_usage_logs.sql  # 数据库迁移
```

### 安全机制

1. **管理员认证**: 只有 `ADMIN_EMAIL` 指定的邮箱可以访问
2. **RLS 策略**: 数据库表启用行级安全，只有 service_role 可以查询
3. **API 保护**: 所有管理 API 都使用 `requireAdmin` 中间件

### 自动日志记录

视频处理 API 会自动记录：
- ✅ 用户信息（ID、邮箱）
- ✅ 视频链接（原始、处理后）
- ✅ 积分变化（消耗、剩余）
- ✅ 处理状态（成功/失败）
- ✅ 错误信息（如果失败）
- ✅ 平台类型（小红书/抖音）
- ✅ IP 地址
- ✅ User Agent

---

## 🎨 UI 特性

- 响应式设计（支持移动端）
- 实时数据刷新按钮
- 表格悬停效果
- 链接可点击跳转
- 积分颜色标识
- 相对时间显示

---

## 🔮 未来扩展（第二版）

- [ ] 图表展示（使用趋势、积分消耗趋势）
- [ ] 高级搜索（按平台、视频大小等）
- [ ] 导出功能（导出 Excel/CSV）
- [ ] 用户操作（手动调整积分、封禁用户）
- [ ] 实时通知（新用户注册、处理失败告警）

---

## 📝 注意事项

1. **首次使用**: 数据库表为空，统计数据都是 0，这是正常的
2. **测试数据**: 可以先处理几个视频来生成测试数据
3. **性能**: 大量数据时，查询可能较慢，已添加索引优化
4. **权限**: 确保 `.env.local` 中的 `ADMIN_EMAIL` 正确配置

---

## 🐛 常见问题

**Q: 访问 /admin 返回 403？**
- 检查是否使用正确的管理员邮箱登录
- 检查 `.env.local` 中的 `ADMIN_EMAIL` 是否正确

**Q: 统计数据显示为 0？**
- 正常，首次使用时数据库为空
- 处理几个视频后数据会更新

**Q: 日志表格为空？**
- 确保已在 Supabase 中执行了 SQL 创建表
- 确保视频处理 API 已更新（包含日志记录代码）

**Q: 用户列表为空？**
- 确保有用户注册
- 检查 Supabase 中的 `user_profiles` 表

---

## 📞 联系方式

如有问题，请联系管理员：595386830@qq.com
