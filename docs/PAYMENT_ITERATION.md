# æ”¯ä»˜ç³»ç»Ÿè¿­ä»£è®¡åˆ’ - è®¢é˜…åŠŸèƒ½

## ğŸ“‹ é¡¹ç›®æ¦‚è¿°

æœ¬æ¬¡è¿­ä»£å°†ç°æœ‰çš„ä¸€æ¬¡æ€§ç§¯åˆ†è´­ä¹°ç³»ç»Ÿå‡çº§ä¸ºå®Œæ•´çš„è®¢é˜…+å……å€¼åŒè½¨åˆ¶æ”¯ä»˜ç³»ç»Ÿã€‚

**å‚è€ƒè®¾è®¡ï¼š** https://sora2ai.io/pricing

**è¿­ä»£åç§°ï¼š** æ”¯ä»˜è¿­ä»£ v2.0

**å®æ–½æ—¥æœŸï¼š** 2025-01-16

---

## ğŸ¯ æ ¸å¿ƒç›®æ ‡

1. âœ… æ”¯æŒæœˆä»˜/å¹´ä»˜è®¢é˜…ï¼ˆå¹´ä»˜5æŠ˜ä¼˜æƒ ï¼‰
2. âœ… æä¾›3æ¡£è®¢é˜…å¥—é¤ï¼ˆå…¥é—¨ç‰ˆã€é«˜çº§ç‰ˆã€ä¸“ä¸šç‰ˆï¼‰
3. âœ… ä¿ç•™ä¸€æ¬¡æ€§å……å€¼åŠŸèƒ½ï¼ˆ2ä¸ªå……å€¼åŒ…ï¼‰
4. âœ… å®ç°è®¢é˜…ç§¯åˆ†ä¸æ™®é€šç§¯åˆ†åˆ†ç¦»ç®¡ç†
5. âœ… æ”¯æŒè®¢é˜…ç®¡ç†ï¼ˆå–æ¶ˆã€å‡çº§ã€é™çº§ï¼‰
6. âœ… æ¯æœˆè‡ªåŠ¨é‡ç½®è®¢é˜…ç§¯åˆ†
7. âœ… æŒ‰å¥—é¤ç­‰çº§æä¾›å·®å¼‚åŒ–åŠŸèƒ½

---

## ğŸ“Š å®šä»·æ–¹æ¡ˆè®¾è®¡

### è®¢é˜…å¥—é¤

| å¥—é¤ | æœˆä»˜ä»·æ ¼ | å¹´ä»˜ä»·æ ¼ | æœˆç§¯åˆ† | å¹´ç§¯åˆ† | æ ¸å¿ƒåŠŸèƒ½ |
|------|---------|---------|--------|--------|---------|
| å…¥é—¨ç‰ˆ Starter | Â¥199 / $29.9 | Â¥1,194 / $179.4 | 1,000 | 12,000 | 720pè§†é¢‘ã€5-10ç§’ã€éŸ³é¢‘æ”¯æŒ |
| é«˜çº§ç‰ˆ Premium â­ | Â¥349 / $49.9 | Â¥2,094 / $299.4 | 2,000 | 24,000 | 1080pè§†é¢‘ã€ä¼˜å…ˆå¤„ç†ã€å•†ä¸šæˆæƒ |
| ä¸“ä¸šç‰ˆ Advanced | Â¥599 / $89.9 | Â¥3,594 / $539.4 | 5,000 | 60,000 | æ— é™1080pã€æœ€å¿«é€Ÿåº¦ã€ä¸“å±æ”¯æŒ |

### ä¸€æ¬¡æ€§å……å€¼åŒ…

| å……å€¼åŒ… | ä»·æ ¼ | ç§¯åˆ† | ç‰¹ç‚¹ |
|--------|------|------|------|
| å°é¢å……å€¼ | Â¥350 / $50 | 2,000 | 720pç”Ÿæˆã€æ°¸ä¹…å†å² |
| å¤§é¢å……å€¼ | Â¥700 / $100 | 5,000 | 1080pç”Ÿæˆã€æ°¸ä¹…å†å² |

---

## ğŸ—ï¸ ç³»ç»Ÿæ¶æ„è®¾è®¡

### æ•°æ®åº“æ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   auth.users    â”‚
â”‚  (Supabase Auth)â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â”‚ 1:1
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      1:0..1     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  user_profiles  â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚  subscriptions   â”‚
â”‚  - credits      â”‚                  â”‚  - plan_type     â”‚
â”‚  - subscription â”‚                  â”‚  - billing_cycle â”‚
â”‚    _credits     â”‚                  â”‚  - status        â”‚
â”‚  - plan_tier    â”‚                  â”‚  - monthly_creditsâ”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜                  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â”‚ 1:N
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ payment_records â”‚
â”‚  - payment_type â”‚
â”‚  - plan_type    â”‚
â”‚  - billing_cycleâ”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### ç§¯åˆ†æ¶ˆè´¹ä¼˜å…ˆçº§

```
ç”¨æˆ·è¯·æ±‚æ¶ˆè´¹ç§¯åˆ†
    â”‚
    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ æ£€æŸ¥è®¢é˜…ç§¯åˆ†      â”‚ â”€â”€â”€ æœ‰ç§¯åˆ† â”€â”€â†’ æ‰£é™¤è®¢é˜…ç§¯åˆ† â”€â”€â†’ æˆåŠŸ
â”‚ subscription     â”‚
â”‚ _credits > 0?    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â”‚
    â”‚ æ— ç§¯åˆ†
    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ æ£€æŸ¥æ™®é€šç§¯åˆ†      â”‚ â”€â”€â”€ æœ‰ç§¯åˆ† â”€â”€â†’ æ‰£é™¤æ™®é€šç§¯åˆ† â”€â”€â†’ æˆåŠŸ
â”‚ credits > 0?     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â”‚
    â”‚ æ— ç§¯åˆ†
    â–¼
   å¤±è´¥
```

---

## ğŸš€ åˆ†é˜¶æ®µå®æ–½è®¡åˆ’

---

## ğŸ“¦ ç¬¬ä¸€é˜¶æ®µï¼šæ•°æ®åº“æ¶æ„æ›´æ–°

**ç›®æ ‡ï¼š** åˆ›å»ºè®¢é˜…ç›¸å…³æ•°æ®è¡¨å’Œå­—æ®µ

**æ—¶é—´ä¼°è®¡ï¼š** 1å¤©

**å¯ç‹¬ç«‹æµ‹è¯•ï¼š** âœ… æ˜¯

### 1.1 åˆ›å»ºè¿ç§»æ–‡ä»¶

**æ–‡ä»¶ï¼š** `supabase/migrations/20250116000000_add_subscriptions.sql`

```sql
-- ============================================
-- è®¢é˜…ç³»ç»Ÿæ•°æ®åº“è¿ç§»
-- ç‰ˆæœ¬: 2.0
-- æ—¥æœŸ: 2025-01-16
-- ============================================

-- ç¬¬ä¸€æ­¥ï¼šåˆ›å»ºè®¢é˜…è¡¨
-- ============================================
CREATE TABLE IF NOT EXISTS public.subscriptions (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID REFERENCES auth.users(id) NOT NULL,

  -- è®¢é˜…è®¡åˆ’ä¿¡æ¯
  plan_type TEXT NOT NULL CHECK (plan_type IN ('starter', 'premium', 'advanced')),
  billing_cycle TEXT NOT NULL CHECK (billing_cycle IN ('monthly', 'annual')),

  -- è®¢é˜…çŠ¶æ€
  status TEXT NOT NULL CHECK (status IN ('active', 'cancelled', 'past_due', 'paused', 'trialing')),

  -- Stripe å…³è”ä¿¡æ¯
  stripe_subscription_id TEXT UNIQUE,
  stripe_customer_id TEXT,
  stripe_price_id TEXT,

  -- è®¡è´¹å‘¨æœŸ
  current_period_start TIMESTAMPTZ NOT NULL,
  current_period_end TIMESTAMPTZ NOT NULL,
  cancel_at_period_end BOOLEAN DEFAULT FALSE,
  cancelled_at TIMESTAMPTZ,

  -- ç§¯åˆ†é…ç½®
  monthly_credits INTEGER NOT NULL,
  credits_used_this_period INTEGER DEFAULT 0,
  credits_reset_at TIMESTAMPTZ,

  -- æ—¶é—´æˆ³
  created_at TIMESTAMPTZ DEFAULT NOW() NOT NULL,
  updated_at TIMESTAMPTZ DEFAULT NOW() NOT NULL,

  -- ç¡®ä¿æ¯ä¸ªç”¨æˆ·åªæœ‰ä¸€ä¸ªæ´»è·ƒè®¢é˜…
  CONSTRAINT unique_active_subscription UNIQUE (user_id, status)
);

-- è®¢é˜…è¡¨æ³¨é‡Š
COMMENT ON TABLE public.subscriptions IS 'ç”¨æˆ·è®¢é˜…è®°å½•è¡¨';
COMMENT ON COLUMN public.subscriptions.plan_type IS 'è®¢é˜…å¥—é¤ç±»å‹ï¼šstarter/premium/advanced';
COMMENT ON COLUMN public.subscriptions.billing_cycle IS 'è®¡è´¹å‘¨æœŸï¼šmonthly/annual';
COMMENT ON COLUMN public.subscriptions.status IS 'è®¢é˜…çŠ¶æ€ï¼šactive/cancelled/past_due/paused/trialing';
COMMENT ON COLUMN public.subscriptions.cancel_at_period_end IS 'æ˜¯å¦åœ¨å‘¨æœŸç»“æŸæ—¶å–æ¶ˆ';
COMMENT ON COLUMN public.subscriptions.credits_used_this_period IS 'å½“å‰å‘¨æœŸå·²ä½¿ç”¨ç§¯åˆ†æ•°';

-- ç¬¬äºŒæ­¥ï¼šä¸º user_profiles æ·»åŠ è®¢é˜…å­—æ®µ
-- ============================================
ALTER TABLE public.user_profiles
  ADD COLUMN IF NOT EXISTS subscription_id UUID REFERENCES public.subscriptions(id) ON DELETE SET NULL;

ALTER TABLE public.user_profiles
  ADD COLUMN IF NOT EXISTS plan_tier TEXT DEFAULT 'free' CHECK (plan_tier IN ('free', 'starter', 'premium', 'advanced'));

ALTER TABLE public.user_profiles
  ADD COLUMN IF NOT EXISTS subscription_credits INTEGER DEFAULT 0 NOT NULL;

ALTER TABLE public.user_profiles
  ADD COLUMN IF NOT EXISTS credits_reset_at TIMESTAMPTZ;

-- user_profiles å­—æ®µæ³¨é‡Š
COMMENT ON COLUMN public.user_profiles.subscription_id IS 'å…³è”çš„è®¢é˜…ID';
COMMENT ON COLUMN public.user_profiles.plan_tier IS 'ç”¨æˆ·å¥—é¤ç­‰çº§ï¼šfree/starter/premium/advanced';
COMMENT ON COLUMN public.user_profiles.subscription_credits IS 'è®¢é˜…ç§¯åˆ†ä½™é¢ï¼ˆæ¯æœˆé‡ç½®ï¼‰';
COMMENT ON COLUMN public.user_profiles.credits_reset_at IS 'ç§¯åˆ†ä¸‹æ¬¡é‡ç½®æ—¶é—´';

-- ç¬¬ä¸‰æ­¥ï¼šæ›´æ–° payment_records è¡¨
-- ============================================
ALTER TABLE public.payment_records
  ADD COLUMN IF NOT EXISTS payment_type TEXT DEFAULT 'onetime' CHECK (payment_type IN ('onetime', 'subscription'));

ALTER TABLE public.payment_records
  ADD COLUMN IF NOT EXISTS plan_type TEXT;

ALTER TABLE public.payment_records
  ADD COLUMN IF NOT EXISTS billing_cycle TEXT CHECK (billing_cycle IN ('monthly', 'annual'));

ALTER TABLE public.payment_records
  ADD COLUMN IF NOT EXISTS subscription_id UUID REFERENCES public.subscriptions(id) ON DELETE SET NULL;

-- payment_records å­—æ®µæ³¨é‡Š
COMMENT ON COLUMN public.payment_records.payment_type IS 'æ”¯ä»˜ç±»å‹ï¼šonetimeä¸€æ¬¡æ€§/subscriptionè®¢é˜…';
COMMENT ON COLUMN public.payment_records.plan_type IS 'å¥—é¤ç±»å‹ï¼ˆè®¢é˜…æ”¯ä»˜æ—¶å¡«å†™ï¼‰';
COMMENT ON COLUMN public.payment_records.billing_cycle IS 'è®¡è´¹å‘¨æœŸï¼ˆè®¢é˜…æ”¯ä»˜æ—¶å¡«å†™ï¼‰';
COMMENT ON COLUMN public.payment_records.subscription_id IS 'å…³è”çš„è®¢é˜…IDï¼ˆè®¢é˜…æ”¯ä»˜æ—¶å¡«å†™ï¼‰';

-- ç¬¬å››æ­¥ï¼šåˆ›å»ºç´¢å¼•
-- ============================================
CREATE INDEX IF NOT EXISTS idx_subscriptions_user_id ON public.subscriptions(user_id);
CREATE INDEX IF NOT EXISTS idx_subscriptions_status ON public.subscriptions(status);
CREATE INDEX IF NOT EXISTS idx_subscriptions_stripe_subscription_id ON public.subscriptions(stripe_subscription_id);
CREATE INDEX IF NOT EXISTS idx_subscriptions_stripe_customer_id ON public.subscriptions(stripe_customer_id);
CREATE INDEX IF NOT EXISTS idx_subscriptions_current_period_end ON public.subscriptions(current_period_end);

CREATE INDEX IF NOT EXISTS idx_user_profiles_subscription_id ON public.user_profiles(subscription_id);
CREATE INDEX IF NOT EXISTS idx_user_profiles_plan_tier ON public.user_profiles(plan_tier);

CREATE INDEX IF NOT EXISTS idx_payment_records_payment_type ON public.payment_records(payment_type);
CREATE INDEX IF NOT EXISTS idx_payment_records_subscription_id ON public.payment_records(subscription_id);

-- ç¬¬äº”æ­¥ï¼šå¯ç”¨ RLSï¼ˆè¡Œçº§å®‰å…¨ï¼‰
-- ============================================
ALTER TABLE public.subscriptions ENABLE ROW LEVEL SECURITY;

-- ç”¨æˆ·åªèƒ½æŸ¥çœ‹è‡ªå·±çš„è®¢é˜…
CREATE POLICY "Users can view own subscriptions"
  ON public.subscriptions
  FOR SELECT
  USING (auth.uid() = user_id);

-- ç”¨æˆ·å¯ä»¥æ’å…¥è‡ªå·±çš„è®¢é˜…ï¼ˆç”± API æ§åˆ¶ï¼‰
CREATE POLICY "Users can insert own subscriptions"
  ON public.subscriptions
  FOR INSERT
  WITH CHECK (auth.uid() = user_id);

-- ç”¨æˆ·å¯ä»¥æ›´æ–°è‡ªå·±çš„è®¢é˜…ï¼ˆç”± API æ§åˆ¶ï¼‰
CREATE POLICY "Users can update own subscriptions"
  ON public.subscriptions
  FOR UPDATE
  USING (auth.uid() = user_id)
  WITH CHECK (auth.uid() = user_id);

-- Service role å¯ä»¥å®Œå…¨è®¿é—®ï¼ˆç”¨äº webhookï¼‰
CREATE POLICY "Service role has full access to subscriptions"
  ON public.subscriptions
  FOR ALL
  USING (auth.jwt() ->> 'role' = 'service_role');

-- ç¬¬å…­æ­¥ï¼šæ·»åŠ  updated_at è§¦å‘å™¨
-- ============================================
CREATE TRIGGER update_subscriptions_updated_at
  BEFORE UPDATE ON public.subscriptions
  FOR EACH ROW
  EXECUTE FUNCTION public.update_updated_at_column();

-- ç¬¬ä¸ƒæ­¥ï¼šæ›´æ–°ç°æœ‰ payment_records RLS ç­–ç•¥ä»¥æ”¯æŒ service role
-- ============================================
DROP POLICY IF EXISTS "Service role has full access to payments" ON public.payment_records;

CREATE POLICY "Service role has full access to payments"
  ON public.payment_records
  FOR ALL
  USING (auth.jwt() ->> 'role' = 'service_role');
```

### 1.2 æµ‹è¯•æ£€æŸ¥ç‚¹ âœ“

**æµ‹è¯•æ­¥éª¤ï¼š**

1. **åœ¨ Supabase SQL ç¼–è¾‘å™¨ä¸­è¿è¡Œè¿ç§»**
   ```bash
   # æœ¬åœ°æµ‹è¯•ï¼ˆå¦‚æœä½¿ç”¨æœ¬åœ° Supabaseï¼‰
   supabase db reset

   # æˆ–è€…åœ¨ Supabase Dashboard çš„ SQL Editor ä¸­æ‰§è¡Œ
   ```

2. **éªŒè¯è¡¨ç»“æ„**
   ```sql
   -- æ£€æŸ¥ subscriptions è¡¨
   SELECT column_name, data_type, is_nullable, column_default
   FROM information_schema.columns
   WHERE table_schema = 'public' AND table_name = 'subscriptions'
   ORDER BY ordinal_position;

   -- æ£€æŸ¥ user_profiles æ–°å­—æ®µ
   SELECT column_name, data_type, is_nullable, column_default
   FROM information_schema.columns
   WHERE table_schema = 'public' AND table_name = 'user_profiles'
   AND column_name IN ('subscription_id', 'plan_tier', 'subscription_credits', 'credits_reset_at');

   -- æ£€æŸ¥ payment_records æ–°å­—æ®µ
   SELECT column_name, data_type, is_nullable, column_default
   FROM information_schema.columns
   WHERE table_schema = 'public' AND table_name = 'payment_records'
   AND column_name IN ('payment_type', 'plan_type', 'billing_cycle', 'subscription_id');
   ```

3. **éªŒè¯ç´¢å¼•åˆ›å»º**
   ```sql
   -- æŸ¥çœ‹æ‰€æœ‰ç´¢å¼•
   SELECT tablename, indexname, indexdef
   FROM pg_indexes
   WHERE schemaname = 'public'
   AND tablename IN ('subscriptions', 'user_profiles', 'payment_records')
   ORDER BY tablename, indexname;
   ```

4. **éªŒè¯ RLS ç­–ç•¥**
   ```sql
   -- æŸ¥çœ‹ subscriptions è¡¨çš„ RLS ç­–ç•¥
   SELECT schemaname, tablename, policyname, permissive, roles, cmd, qual, with_check
   FROM pg_policies
   WHERE schemaname = 'public' AND tablename = 'subscriptions';
   ```

5. **æµ‹è¯•æ’å…¥æ•°æ®**
   ```sql
   -- æ’å…¥æµ‹è¯•è®¢é˜…æ•°æ®ï¼ˆä½¿ç”¨ç°æœ‰ç”¨æˆ·IDï¼‰
   INSERT INTO public.subscriptions (
     user_id,
     plan_type,
     billing_cycle,
     status,
     stripe_subscription_id,
     stripe_customer_id,
     current_period_start,
     current_period_end,
     monthly_credits
   ) VALUES (
     'ä½ çš„æµ‹è¯•ç”¨æˆ·ID',  -- æ›¿æ¢ä¸ºå®é™…ç”¨æˆ·ID
     'premium',
     'monthly',
     'active',
     'sub_test_123',
     'cus_test_123',
     NOW(),
     NOW() + INTERVAL '1 month',
     2000
   )
   RETURNING *;

   -- éªŒè¯æ•°æ®æ’å…¥æˆåŠŸ
   SELECT * FROM public.subscriptions WHERE stripe_subscription_id = 'sub_test_123';

   -- æ¸…ç†æµ‹è¯•æ•°æ®
   DELETE FROM public.subscriptions WHERE stripe_subscription_id = 'sub_test_123';
   ```

**é¢„æœŸç»“æœï¼š**
- âœ… subscriptions è¡¨åˆ›å»ºæˆåŠŸï¼ŒåŒ…å«æ‰€æœ‰å­—æ®µ
- âœ… user_profiles è¡¨æ–°å¢4ä¸ªå­—æ®µ
- âœ… payment_records è¡¨æ–°å¢4ä¸ªå­—æ®µ
- âœ… æ‰€æœ‰ç´¢å¼•åˆ›å»ºæˆåŠŸ
- âœ… RLS ç­–ç•¥ç”Ÿæ•ˆ
- âœ… æµ‹è¯•æ•°æ®å¯ä»¥æ­£å¸¸æ’å…¥å’ŒæŸ¥è¯¢

**å¦‚æœé‡åˆ°é—®é¢˜ï¼š**
- æ£€æŸ¥å­—æ®µç±»å‹æ˜¯å¦åŒ¹é…
- æ£€æŸ¥å¤–é”®çº¦æŸæ˜¯å¦æ­£ç¡®
- æ£€æŸ¥ CHECK çº¦æŸçš„å€¼æ˜¯å¦æ­£ç¡®
- æ£€æŸ¥ RLS ç­–ç•¥æ˜¯å¦é˜»æ­¢äº†æ“ä½œ

---

## ğŸ”§ ç¬¬äºŒé˜¶æ®µï¼šæ•°æ®åº“å‡½æ•°

**ç›®æ ‡ï¼š** åˆ›å»ºè®¢é˜…ç§¯åˆ†ç®¡ç†å‡½æ•°

**æ—¶é—´ä¼°è®¡ï¼š** 0.5å¤©

**å¯ç‹¬ç«‹æµ‹è¯•ï¼š** âœ… æ˜¯

### 2.1 åˆ›å»ºè¿ç§»æ–‡ä»¶

**æ–‡ä»¶ï¼š** `supabase/migrations/20250116000001_subscription_functions.sql`

```sql
-- ============================================
-- è®¢é˜…ç³»ç»Ÿå‡½æ•°
-- ç‰ˆæœ¬: 2.0
-- æ—¥æœŸ: 2025-01-16
-- ============================================

-- å‡½æ•°1ï¼šé‡ç½®æ‰€æœ‰è®¢é˜…ç§¯åˆ†ï¼ˆç”±å®šæ—¶ä»»åŠ¡è°ƒç”¨ï¼‰
-- ============================================
CREATE OR REPLACE FUNCTION public.reset_subscription_credits()
RETURNS TABLE (
  user_id UUID,
  old_credits INTEGER,
  new_credits INTEGER,
  subscription_id UUID
) AS $$
BEGIN
  RETURN QUERY
  UPDATE public.user_profiles up
  SET
    subscription_credits = s.monthly_credits,
    credits_reset_at = s.current_period_end,
    updated_at = NOW()
  FROM public.subscriptions s
  WHERE up.subscription_id = s.id
    AND s.status = 'active'
    AND s.current_period_end <= NOW()
  RETURNING
    up.id,
    up.subscription_credits,
    s.monthly_credits,
    s.id;
END;
$$ LANGUAGE plpgsql SECURITY DEFINER;

COMMENT ON FUNCTION public.reset_subscription_credits IS 'é‡ç½®æ‰€æœ‰åˆ°æœŸè®¢é˜…çš„ç§¯åˆ†ï¼ˆå®šæ—¶ä»»åŠ¡è°ƒç”¨ï¼‰';

-- å‡½æ•°2ï¼šä¸ºå•ä¸ªç”¨æˆ·é‡ç½®è®¢é˜…ç§¯åˆ†
-- ============================================
CREATE OR REPLACE FUNCTION public.reset_user_subscription_credits(p_user_id UUID)
RETURNS BOOLEAN AS $$
DECLARE
  v_monthly_credits INTEGER;
  v_current_period_end TIMESTAMPTZ;
BEGIN
  -- è·å–ç”¨æˆ·çš„è®¢é˜…ä¿¡æ¯
  SELECT s.monthly_credits, s.current_period_end
  INTO v_monthly_credits, v_current_period_end
  FROM public.subscriptions s
  WHERE s.user_id = p_user_id
    AND s.status = 'active';

  -- å¦‚æœæ²¡æœ‰æ´»è·ƒè®¢é˜…ï¼Œè¿”å›false
  IF NOT FOUND THEN
    RETURN FALSE;
  END IF;

  -- é‡ç½®ç§¯åˆ†
  UPDATE public.user_profiles
  SET
    subscription_credits = v_monthly_credits,
    credits_reset_at = v_current_period_end,
    updated_at = NOW()
  WHERE id = p_user_id;

  RETURN TRUE;
END;
$$ LANGUAGE plpgsql SECURITY DEFINER;

COMMENT ON FUNCTION public.reset_user_subscription_credits IS 'ä¸ºæŒ‡å®šç”¨æˆ·é‡ç½®è®¢é˜…ç§¯åˆ†';

-- å‡½æ•°3ï¼šæ¶ˆè´¹ç§¯åˆ†ï¼ˆä¼˜å…ˆä½¿ç”¨è®¢é˜…ç§¯åˆ†ï¼‰
-- ============================================
CREATE OR REPLACE FUNCTION public.consume_credit_v2(p_user_id UUID)
RETURNS TABLE (
  success BOOLEAN,
  credit_type TEXT,
  remaining_subscription_credits INTEGER,
  remaining_regular_credits INTEGER
) AS $$
DECLARE
  v_subscription_credits INTEGER;
  v_regular_credits INTEGER;
  v_consumed_type TEXT;
BEGIN
  -- é”å®šç”¨æˆ·è¡Œ
  SELECT subscription_credits, credits
  INTO v_subscription_credits, v_regular_credits
  FROM public.user_profiles
  WHERE id = p_user_id
  FOR UPDATE;

  -- ç­–ç•¥1ï¼šä¼˜å…ˆä½¿ç”¨è®¢é˜…ç§¯åˆ†
  IF v_subscription_credits > 0 THEN
    UPDATE public.user_profiles
    SET
      subscription_credits = subscription_credits - 1,
      updated_at = NOW()
    WHERE id = p_user_id
    RETURNING subscription_credits, credits INTO v_subscription_credits, v_regular_credits;

    v_consumed_type := 'subscription';

  -- ç­–ç•¥2ï¼šè®¢é˜…ç§¯åˆ†ä¸è¶³æ—¶ä½¿ç”¨æ™®é€šç§¯åˆ†
  ELSIF v_regular_credits > 0 THEN
    UPDATE public.user_profiles
    SET
      credits = credits - 1,
      updated_at = NOW()
    WHERE id = p_user_id
    RETURNING subscription_credits, credits INTO v_subscription_credits, v_regular_credits;

    v_consumed_type := 'regular';

  -- ç­–ç•¥3ï¼šä¸¤ç§ç§¯åˆ†éƒ½ä¸è¶³
  ELSE
    RETURN QUERY SELECT FALSE, 'none'::TEXT, 0, 0;
    RETURN;
  END IF;

  -- è¿”å›æ¶ˆè´¹ç»“æœ
  RETURN QUERY SELECT TRUE, v_consumed_type, v_subscription_credits, v_regular_credits;
END;
$$ LANGUAGE plpgsql SECURITY DEFINER;

COMMENT ON FUNCTION public.consume_credit_v2 IS 'æ¶ˆè´¹1ä¸ªç§¯åˆ†ï¼Œä¼˜å…ˆä½¿ç”¨è®¢é˜…ç§¯åˆ†ï¼Œè¿”å›æ¶ˆè´¹è¯¦æƒ…';

-- å‡½æ•°4ï¼šè·å–ç”¨æˆ·å®Œæ•´ç§¯åˆ†ä¿¡æ¯
-- ============================================
CREATE OR REPLACE FUNCTION public.get_user_credits_info(p_user_id UUID)
RETURNS TABLE (
  subscription_credits INTEGER,
  regular_credits INTEGER,
  total_credits INTEGER,
  plan_tier TEXT,
  subscription_status TEXT,
  credits_reset_at TIMESTAMPTZ
) AS $$
BEGIN
  RETURN QUERY
  SELECT
    up.subscription_credits,
    up.credits,
    up.subscription_credits + up.credits AS total_credits,
    up.plan_tier,
    COALESCE(s.status, 'none') AS subscription_status,
    up.credits_reset_at
  FROM public.user_profiles up
  LEFT JOIN public.subscriptions s ON up.subscription_id = s.id
  WHERE up.id = p_user_id;
END;
$$ LANGUAGE plpgsql SECURITY DEFINER;

COMMENT ON FUNCTION public.get_user_credits_info IS 'è·å–ç”¨æˆ·å®Œæ•´çš„ç§¯åˆ†å’Œè®¢é˜…ä¿¡æ¯';

-- å‡½æ•°5ï¼šåˆ›å»ºæˆ–æ›´æ–°è®¢é˜…
-- ============================================
CREATE OR REPLACE FUNCTION public.upsert_subscription(
  p_user_id UUID,
  p_plan_type TEXT,
  p_billing_cycle TEXT,
  p_stripe_subscription_id TEXT,
  p_stripe_customer_id TEXT,
  p_stripe_price_id TEXT,
  p_current_period_start TIMESTAMPTZ,
  p_current_period_end TIMESTAMPTZ,
  p_monthly_credits INTEGER
)
RETURNS UUID AS $$
DECLARE
  v_subscription_id UUID;
BEGIN
  -- æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨è®¢é˜…
  SELECT id INTO v_subscription_id
  FROM public.subscriptions
  WHERE stripe_subscription_id = p_stripe_subscription_id;

  IF FOUND THEN
    -- æ›´æ–°ç°æœ‰è®¢é˜…
    UPDATE public.subscriptions
    SET
      plan_type = p_plan_type,
      billing_cycle = p_billing_cycle,
      stripe_customer_id = p_stripe_customer_id,
      stripe_price_id = p_stripe_price_id,
      current_period_start = p_current_period_start,
      current_period_end = p_current_period_end,
      monthly_credits = p_monthly_credits,
      updated_at = NOW()
    WHERE id = v_subscription_id;
  ELSE
    -- åˆ›å»ºæ–°è®¢é˜…
    INSERT INTO public.subscriptions (
      user_id,
      plan_type,
      billing_cycle,
      status,
      stripe_subscription_id,
      stripe_customer_id,
      stripe_price_id,
      current_period_start,
      current_period_end,
      monthly_credits,
      credits_reset_at
    ) VALUES (
      p_user_id,
      p_plan_type,
      p_billing_cycle,
      'active',
      p_stripe_subscription_id,
      p_stripe_customer_id,
      p_stripe_price_id,
      p_current_period_start,
      p_current_period_end,
      p_monthly_credits,
      p_current_period_end
    )
    RETURNING id INTO v_subscription_id;

    -- æ›´æ–°ç”¨æˆ·èµ„æ–™
    UPDATE public.user_profiles
    SET
      subscription_id = v_subscription_id,
      plan_tier = p_plan_type,
      subscription_credits = p_monthly_credits,
      credits_reset_at = p_current_period_end,
      updated_at = NOW()
    WHERE id = p_user_id;
  END IF;

  RETURN v_subscription_id;
END;
$$ LANGUAGE plpgsql SECURITY DEFINER;

COMMENT ON FUNCTION public.upsert_subscription IS 'åˆ›å»ºæˆ–æ›´æ–°è®¢é˜…ï¼Œå¹¶åŒæ­¥ç”¨æˆ·èµ„æ–™';

-- å‡½æ•°6ï¼šå–æ¶ˆè®¢é˜…ï¼ˆä¸ç«‹å³åˆ é™¤ï¼Œæ ‡è®°ä¸ºå–æ¶ˆï¼‰
-- ============================================
CREATE OR REPLACE FUNCTION public.cancel_subscription(
  p_subscription_id UUID,
  p_cancel_at_period_end BOOLEAN DEFAULT TRUE
)
RETURNS BOOLEAN AS $$
BEGIN
  UPDATE public.subscriptions
  SET
    cancel_at_period_end = p_cancel_at_period_end,
    cancelled_at = CASE
      WHEN NOT p_cancel_at_period_end THEN NOW()
      ELSE cancelled_at
    END,
    status = CASE
      WHEN NOT p_cancel_at_period_end THEN 'cancelled'
      ELSE status
    END,
    updated_at = NOW()
  WHERE id = p_subscription_id;

  -- å¦‚æœç«‹å³å–æ¶ˆï¼Œæ¸…é™¤ç”¨æˆ·çš„è®¢é˜…å…³è”
  IF NOT p_cancel_at_period_end THEN
    UPDATE public.user_profiles
    SET
      subscription_id = NULL,
      plan_tier = 'free',
      subscription_credits = 0,
      credits_reset_at = NULL,
      updated_at = NOW()
    WHERE subscription_id = p_subscription_id;
  END IF;

  RETURN FOUND;
END;
$$ LANGUAGE plpgsql SECURITY DEFINER;

COMMENT ON FUNCTION public.cancel_subscription IS 'å–æ¶ˆè®¢é˜…ï¼Œå¯é€‰æ‹©åœ¨å‘¨æœŸç»“æŸæ—¶å–æ¶ˆæˆ–ç«‹å³å–æ¶ˆ';
```

### 2.2 æµ‹è¯•æ£€æŸ¥ç‚¹ âœ“

**æµ‹è¯•æ­¥éª¤ï¼š**

1. **åœ¨ SQL ç¼–è¾‘å™¨ä¸­è¿è¡Œå‡½æ•°è¿ç§»**

2. **æµ‹è¯•å‡½æ•°1ï¼šé‡ç½®è®¢é˜…ç§¯åˆ†**
   ```sql
   -- å‡†å¤‡ï¼šåˆ›å»ºæµ‹è¯•è®¢é˜…
   INSERT INTO public.subscriptions (
     user_id,
     plan_type,
     billing_cycle,
     status,
     stripe_subscription_id,
     current_period_start,
     current_period_end,
     monthly_credits
   ) VALUES (
     'ä½ çš„ç”¨æˆ·ID',
     'premium',
     'monthly',
     'active',
     'sub_test_reset',
     NOW() - INTERVAL '1 month',
     NOW() - INTERVAL '1 day',  -- å·²è¿‡æœŸ
     2000
   )
   RETURNING id;

   -- æ‰§è¡Œé‡ç½®
   SELECT * FROM public.reset_subscription_credits();

   -- éªŒè¯ç»“æœ
   SELECT subscription_credits, credits_reset_at
   FROM public.user_profiles
   WHERE id = 'ä½ çš„ç”¨æˆ·ID';
   ```

3. **æµ‹è¯•å‡½æ•°3ï¼šæ¶ˆè´¹ç§¯åˆ†**
   ```sql
   -- æŸ¥çœ‹å½“å‰ç§¯åˆ†
   SELECT subscription_credits, credits
   FROM public.user_profiles
   WHERE id = 'ä½ çš„ç”¨æˆ·ID';

   -- æ¶ˆè´¹1ä¸ªç§¯åˆ†
   SELECT * FROM public.consume_credit_v2('ä½ çš„ç”¨æˆ·ID');

   -- å†æ¬¡æŸ¥çœ‹ç§¯åˆ†ï¼ˆåº”è¯¥å‡å°‘1ï¼‰
   SELECT subscription_credits, credits
   FROM public.user_profiles
   WHERE id = 'ä½ çš„ç”¨æˆ·ID';
   ```

4. **æµ‹è¯•å‡½æ•°4ï¼šè·å–ç§¯åˆ†ä¿¡æ¯**
   ```sql
   SELECT * FROM public.get_user_credits_info('ä½ çš„ç”¨æˆ·ID');
   ```

5. **æµ‹è¯•å‡½æ•°5ï¼šåˆ›å»ºè®¢é˜…**
   ```sql
   SELECT public.upsert_subscription(
     'ä½ çš„ç”¨æˆ·ID',
     'starter',
     'monthly',
     'sub_test_new',
     'cus_test_new',
     'price_test',
     NOW(),
     NOW() + INTERVAL '1 month',
     1000
   );

   -- éªŒè¯è®¢é˜…åˆ›å»º
   SELECT * FROM public.subscriptions WHERE stripe_subscription_id = 'sub_test_new';
   SELECT subscription_credits, plan_tier FROM public.user_profiles WHERE id = 'ä½ çš„ç”¨æˆ·ID';
   ```

6. **æµ‹è¯•å‡½æ•°6ï¼šå–æ¶ˆè®¢é˜…**
   ```sql
   -- å‘¨æœŸç»“æŸæ—¶å–æ¶ˆ
   SELECT public.cancel_subscription(
     (SELECT id FROM public.subscriptions WHERE stripe_subscription_id = 'sub_test_new'),
     TRUE
   );

   -- éªŒè¯çŠ¶æ€
   SELECT cancel_at_period_end, status FROM public.subscriptions WHERE stripe_subscription_id = 'sub_test_new';
   ```

7. **æ¸…ç†æµ‹è¯•æ•°æ®**
   ```sql
   DELETE FROM public.subscriptions WHERE stripe_subscription_id LIKE 'sub_test%';
   ```

**é¢„æœŸç»“æœï¼š**
- âœ… æ‰€æœ‰å‡½æ•°åˆ›å»ºæˆåŠŸ
- âœ… `reset_subscription_credits()` å¯ä»¥é‡ç½®è¿‡æœŸè®¢é˜…
- âœ… `consume_credit_v2()` ä¼˜å…ˆæ¶ˆè´¹è®¢é˜…ç§¯åˆ†
- âœ… `get_user_credits_info()` è¿”å›å®Œæ•´ç§¯åˆ†ä¿¡æ¯
- âœ… `upsert_subscription()` å¯åˆ›å»ºå’Œæ›´æ–°è®¢é˜…
- âœ… `cancel_subscription()` å¯æ­£ç¡®æ ‡è®°å–æ¶ˆçŠ¶æ€

---

## ğŸ“ ç¬¬ä¸‰é˜¶æ®µï¼šTypeScript ç±»å‹å®šä¹‰

**ç›®æ ‡ï¼š** æ‰©å±•æ”¯ä»˜ç±»å‹å®šä¹‰ï¼Œæ”¯æŒè®¢é˜…

**æ—¶é—´ä¼°è®¡ï¼š** 0.5å¤©

**å¯ç‹¬ç«‹æµ‹è¯•ï¼š** âœ… æ˜¯ï¼ˆé€šè¿‡ TypeScript ç¼–è¯‘ï¼‰

### 3.1 æ›´æ–°æ”¯ä»˜ç±»å‹æ–‡ä»¶

**æ–‡ä»¶ï¼š** `lib/payment/types.ts`

```typescript
// ============================================
// æ”¯ä»˜ç³»ç»Ÿç±»å‹å®šä¹‰ v2.0
// æ”¯æŒè®¢é˜… + ä¸€æ¬¡æ€§å……å€¼
// ============================================

// åŸºç¡€ç±»å‹
// ============================================
export type SubscriptionPlan = 'starter' | 'premium' | 'advanced';
export type BillingCycle = 'monthly' | 'annual';
export type PaymentType = 'onetime' | 'subscription';
export type SubscriptionStatus = 'active' | 'cancelled' | 'past_due' | 'paused' | 'trialing';
export type PlanTier = 'free' | 'starter' | 'premium' | 'advanced';

// è®¢é˜…å¥—é¤æ¥å£
// ============================================
export interface SubscriptionPackage {
  id: string;
  planType: SubscriptionPlan;
  name: {
    zh: string;
    en: string;
  };
  description: {
    zh: string;
    en: string;
  };
  monthlyPrice: {
    usd: number;
    cny: number;
  };
  annualPrice: {
    usd: number;
    cny: number;
  };
  monthlyCredits: number;
  annualCredits: number;
  features: {
    zh: string[];
    en: string[];
  };
  excludedFeatures?: {
    zh: string[];
    en: string[];
  };
  isPopular?: boolean;
  icon: string; // emoji å›¾æ ‡
}

// å……å€¼åŒ…æ¥å£
// ============================================
export interface AddonPackage {
  id: string;
  name: {
    zh: string;
    en: string;
  };
  description: {
    zh: string;
    en: string;
  };
  price: {
    usd: number;
    cny: number;
  };
  credits: number;
  features: {
    zh: string[];
    en: string[];
  };
  icon: string;
}

// è®¢é˜…æ•°æ®åº“è®°å½•
// ============================================
export interface Subscription {
  id: string;
  user_id: string;
  plan_type: SubscriptionPlan;
  billing_cycle: BillingCycle;
  status: SubscriptionStatus;
  stripe_subscription_id: string;
  stripe_customer_id: string;
  stripe_price_id: string;
  current_period_start: string;
  current_period_end: string;
  cancel_at_period_end: boolean;
  cancelled_at: string | null;
  monthly_credits: number;
  credits_used_this_period: number;
  credits_reset_at: string;
  created_at: string;
  updated_at: string;
}

// æ”¯ä»˜è®°å½•ï¼ˆæ‰©å±•ï¼‰
// ============================================
export interface PaymentRecord {
  id: string;
  user_id: string;
  amount: number;
  credits: number;
  stripe_session_id: string;
  status: 'pending' | 'completed' | 'failed';
  payment_type: PaymentType;
  plan_type?: SubscriptionPlan;
  billing_cycle?: BillingCycle;
  subscription_id?: string;
  created_at: string;
  completed_at: string | null;
}

// Stripe ç»“è´¦è¯·æ±‚
// ============================================
export interface CreateSubscriptionCheckoutRequest {
  planType: SubscriptionPlan;
  billingCycle: BillingCycle;
  currency: 'usd' | 'cny';
  locale: string;
}

export interface CreateAddonCheckoutRequest {
  addonId: string;
  currency: 'usd' | 'cny';
  locale: string;
}

// åŸæœ‰çš„ä¸€æ¬¡æ€§å……å€¼ï¼ˆä¿æŒå‘åå…¼å®¹ï¼‰
export interface CreateCheckoutSessionRequest {
  amount: number;
  credits: number;
  currency: 'usd' | 'cny';
  locale: string;
}

// è®¢é˜…å¥—é¤é…ç½®
// ============================================
export const SUBSCRIPTION_PLANS: SubscriptionPackage[] = [
  {
    id: 'starter',
    planType: 'starter',
    name: {
      zh: 'å…¥é—¨ç‰ˆ',
      en: 'Starter',
    },
    description: {
      zh: 'é€‚åˆåˆå­¦è€…',
      en: 'Perfect for beginners',
    },
    monthlyPrice: {
      usd: 29.9,
      cny: 199,
    },
    annualPrice: {
      usd: 179.4,  // 50% æŠ˜æ‰£
      cny: 1194,
    },
    monthlyCredits: 1000,
    annualCredits: 12000,
    features: {
      zh: [
        'æ¯æœˆ1,000ç§¯åˆ†',
        '720pè§†é¢‘ç”Ÿæˆ',
        '5-10ç§’è§†é¢‘',
        'éŸ³é¢‘æ”¯æŒ',
        'æ— å†…å®¹é™åˆ¶',
      ],
      en: [
        '1,000 credits per month',
        '720p video generation',
        '5-10 second videos',
        'Audio support',
        'Unrestricted content policy',
      ],
    },
    excludedFeatures: {
      zh: ['å•†ä¸šæˆæƒå’Œä¼˜å…ˆæ”¯æŒ'],
      en: ['Commercial license & Priority support'],
    },
    icon: 'ğŸš€',
  },
  {
    id: 'premium',
    planType: 'premium',
    name: {
      zh: 'é«˜çº§ç‰ˆ',
      en: 'Premium',
    },
    description: {
      zh: 'æœ€å—æ¬¢è¿çš„é€‰æ‹©',
      en: 'Most popular choice',
    },
    monthlyPrice: {
      usd: 49.9,
      cny: 349,
    },
    annualPrice: {
      usd: 299.4,  // 50% æŠ˜æ‰£
      cny: 2094,
    },
    monthlyCredits: 2000,
    annualCredits: 24000,
    features: {
      zh: [
        'æ¯æœˆ2,000ç§¯åˆ†',
        '1080pè§†é¢‘ç”Ÿæˆ',
        'ä¼˜å…ˆå¤„ç†é€Ÿåº¦',
        'éŸ³é¢‘é›†æˆ',
        'æ— å†…å®¹é™åˆ¶',
        'å•†ä¸šæˆæƒ',
      ],
      en: [
        '2,000 credits per month',
        '1080p video generation',
        'Priority processing',
        'Audio integration',
        'Unrestricted content policy',
        'Commercial license & Priority support',
      ],
    },
    isPopular: true,
    icon: 'ğŸ‘‘',
  },
  {
    id: 'advanced',
    planType: 'advanced',
    name: {
      zh: 'ä¸“ä¸šç‰ˆ',
      en: 'Advanced',
    },
    description: {
      zh: 'ä¸ºä¸“ä¸šåˆ›ä½œè€…è®¾è®¡',
      en: 'For power creators',
    },
    monthlyPrice: {
      usd: 89.9,
      cny: 599,
    },
    annualPrice: {
      usd: 539.4,  // 50% æŠ˜æ‰£
      cny: 3594,
    },
    monthlyCredits: 5000,
    annualCredits: 60000,
    features: {
      zh: [
        'æ¯æœˆ5,000ç§¯åˆ†',
        'æ— é™1080pç”Ÿæˆ',
        'æœ€å¿«å¤„ç†é€Ÿåº¦',
        'å®Œæ•´éŸ³é¢‘åŠŸèƒ½',
        'æ— å†…å®¹é™åˆ¶',
        'å•†ä¸šæˆæƒ',
        'ä¸“å±æ”¯æŒ',
      ],
      en: [
        '5,000 credits per month',
        'Unlimited 1080p generation',
        'Fastest processing speed',
        'Full audio features',
        'Unrestricted content policy',
        'Commercial license',
        'Dedicated support',
      ],
    },
    icon: 'ğŸ’',
  },
];

// å……å€¼åŒ…é…ç½®
// ============================================
export const ADDON_PACKAGES: AddonPackage[] = [
  {
    id: 'small-addon',
    name: {
      zh: 'å°é¢å……å€¼åŒ…',
      en: 'Small Add-on Package',
    },
    description: {
      zh: 'æŒ‰éœ€è¡¥å……ç§¯åˆ†',
      en: 'Additional credits as needed',
    },
    price: {
      usd: 50,
      cny: 350,
    },
    credits: 2000,
    features: {
      zh: [
        'ä¸€æ¬¡æ€§è´­ä¹°',
        '2,000ç§¯åˆ†',
        'æ— éœ€è®¢é˜…',
        '720pç”Ÿæˆ',
        'æ°¸ä¹…å†å²è®°å½•',
      ],
      en: [
        'One-Time Package',
        '2000 credits',
        'No subscription',
        '720p generation',
        'Permanent history',
      ],
    },
    icon: 'ğŸ“¦',
  },
  {
    id: 'large-addon',
    name: {
      zh: 'å¤§é¢å……å€¼åŒ…',
      en: 'Large Add-on Package',
    },
    description: {
      zh: 'é€‚åˆé‡åº¦ç”¨æˆ·',
      en: 'More credits for heavy users',
    },
    price: {
      usd: 100,
      cny: 700,
    },
    credits: 5000,
    features: {
      zh: [
        'ä¸€æ¬¡æ€§è´­ä¹°',
        '5,000ç§¯åˆ†',
        'æ— éœ€è®¢é˜…',
        '1080pç”Ÿæˆ',
        'æ°¸ä¹…å†å²è®°å½•',
      ],
      en: [
        'One-Time Package',
        '5000 credits',
        'No subscription',
        '1080p generation',
        'Permanent history',
      ],
    },
    icon: 'ğŸ“¦',
  },
];

// åŸæœ‰é…ç½®ï¼ˆä¿æŒå‘åå…¼å®¹ï¼‰
// ============================================
export interface PaymentPackage {
  amountUSD: number;
  amountCNY: number;
  credits: number;
  label: string;
  popular?: boolean;
}

export const PAYMENT_PACKAGES: PaymentPackage[] = [
  {
    amountUSD: 1,
    amountCNY: 10,
    credits: 10,
    label: 'starter',
  },
  {
    amountUSD: 5,
    amountCNY: 50,
    credits: 50,
    label: 'standard',
    popular: true,
  },
  {
    amountUSD: 10,
    amountCNY: 100,
    credits: 100,
    label: 'premium',
  },
];

// æ±‡ç‡é…ç½®
export const CREDITS_PER_DOLLAR = 10;
export const CREDITS_PER_YUAN = 1;
export const MIN_AMOUNT_USD = 1;
export const MIN_AMOUNT_CNY = 10;

// è¾…åŠ©å‡½æ•°ï¼šæ ¹æ®IDè·å–å¥—é¤
// ============================================
export function getSubscriptionPlan(planType: SubscriptionPlan): SubscriptionPackage | undefined {
  return SUBSCRIPTION_PLANS.find((plan) => plan.planType === planType);
}

export function getAddonPackage(addonId: string): AddonPackage | undefined {
  return ADDON_PACKAGES.find((addon) => addon.id === addonId);
}

// è¾…åŠ©å‡½æ•°ï¼šè®¡ç®—å¹´ä»˜æŠ˜æ‰£
// ============================================
export function getAnnualDiscount(plan: SubscriptionPackage): number {
  const monthlyTotal = plan.monthlyPrice.usd * 12;
  const annualPrice = plan.annualPrice.usd;
  return Math.round(((monthlyTotal - annualPrice) / monthlyTotal) * 100);
}

// è¾…åŠ©å‡½æ•°ï¼šæ ¼å¼åŒ–ä»·æ ¼
// ============================================
export function formatPrice(amount: number, currency: 'usd' | 'cny', locale: string): string {
  if (currency === 'usd') {
    return new Intl.NumberFormat(locale, {
      style: 'currency',
      currency: 'USD',
    }).format(amount);
  } else {
    return new Intl.NumberFormat(locale, {
      style: 'currency',
      currency: 'CNY',
    }).format(amount);
  }
}
```

### 3.2 æµ‹è¯•æ£€æŸ¥ç‚¹ âœ“

**æµ‹è¯•æ­¥éª¤ï¼š**

1. **è¿è¡Œ TypeScript ç¼–è¯‘**
   ```bash
   npx tsc --noEmit
   ```

2. **æµ‹è¯•ç±»å‹å¯¼å…¥**
   åˆ›å»ºä¸´æ—¶æµ‹è¯•æ–‡ä»¶ `test-types.ts`ï¼š
   ```typescript
   import {
     SUBSCRIPTION_PLANS,
     ADDON_PACKAGES,
     getSubscriptionPlan,
     getAddonPackage,
     formatPrice,
     type SubscriptionPackage,
     type AddonPackage,
   } from './lib/payment/types';

   // æµ‹è¯•è®¢é˜…å¥—é¤
   const premiumPlan = getSubscriptionPlan('premium');
   console.log('Premium Plan:', premiumPlan?.name.zh);

   // æµ‹è¯•å……å€¼åŒ…
   const smallAddon = getAddonPackage('small-addon');
   console.log('Small Addon:', smallAddon?.name.zh);

   // æµ‹è¯•ä»·æ ¼æ ¼å¼åŒ–
   console.log(formatPrice(49.9, 'usd', 'en-US'));
   console.log(formatPrice(349, 'cny', 'zh-CN'));
   ```

3. **è¿è¡Œæµ‹è¯•æ–‡ä»¶**
   ```bash
   npx ts-node test-types.ts
   ```

**é¢„æœŸç»“æœï¼š**
- âœ… TypeScript ç¼–è¯‘æ— é”™è¯¯
- âœ… ç±»å‹å¯¼å…¥æˆåŠŸ
- âœ… è¾…åŠ©å‡½æ•°æ­£å¸¸å·¥ä½œ
- âœ… é…ç½®æ•°æ®ç»“æ„æ­£ç¡®

---

## ğŸ¨ ç¬¬å››é˜¶æ®µï¼šStripe äº§å“é…ç½®

**ç›®æ ‡ï¼š** åœ¨ Stripe æ§åˆ¶å°åˆ›å»ºäº§å“å’Œä»·æ ¼

**æ—¶é—´ä¼°è®¡ï¼š** 1å¤©

**å¯ç‹¬ç«‹æµ‹è¯•ï¼š** âœ… æ˜¯

### 4.1 Stripe æ§åˆ¶å°æ“ä½œæ­¥éª¤

**è®¿é—®ï¼š** https://dashboard.stripe.com

#### æ­¥éª¤1ï¼šåˆ›å»ºè®¢é˜…äº§å“

1. **å¯¼èˆªåˆ°äº§å“é¡µé¢**
   - ç‚¹å‡»å·¦ä¾§èœå• "Products"
   - ç‚¹å‡» "+ Add product"

2. **åˆ›å»º Starter äº§å“**
   - Name: `Sora AI - Starter Plan`
   - Description: `å…¥é—¨ç‰ˆè®¢é˜…å¥—é¤ï¼ŒåŒ…å«æ¯æœˆ1000ç§¯åˆ†`
   - ç‚¹å‡» "Add pricing"

   **æœˆä»˜ä»·æ ¼ï¼š**
   - Pricing model: `Recurring`
   - Price: `$29.90 USD` æˆ– `Â¥199.00 CNY`
   - Billing period: `Monthly`
   - Price description: `Starter Monthly`

   **å¹´ä»˜ä»·æ ¼ï¼š**
   - å†æ¬¡ç‚¹å‡» "Add another price"
   - Price: `$179.40 USD` æˆ– `Â¥1194.00 CNY`
   - Billing period: `Yearly`
   - Price description: `Starter Annual (50% off)`

3. **åˆ›å»º Premium äº§å“**
   - Name: `Sora AI - Premium Plan`
   - Description: `é«˜çº§ç‰ˆè®¢é˜…å¥—é¤ï¼ŒåŒ…å«æ¯æœˆ2000ç§¯åˆ†`

   **æœˆä»˜ï¼š** `$49.90 USD` / `Â¥349.00 CNY`
   **å¹´ä»˜ï¼š** `$299.40 USD` / `Â¥2094.00 CNY`

4. **åˆ›å»º Advanced äº§å“**
   - Name: `Sora AI - Advanced Plan`
   - Description: `ä¸“ä¸šç‰ˆè®¢é˜…å¥—é¤ï¼ŒåŒ…å«æ¯æœˆ5000ç§¯åˆ†`

   **æœˆä»˜ï¼š** `$89.90 USD` / `Â¥599.00 CNY`
   **å¹´ä»˜ï¼š** `$539.40 USD` / `Â¥3594.00 CNY`

#### æ­¥éª¤2ï¼šåˆ›å»ºä¸€æ¬¡æ€§å……å€¼äº§å“

1. **åˆ›å»º Small Addon**
   - Name: `Sora AI - Small Credit Pack`
   - Description: `å°é¢å……å€¼åŒ…ï¼Œ2000ç§¯åˆ†`
   - Pricing model: `One time`
   - Price: `$50.00 USD` / `Â¥350.00 CNY`

2. **åˆ›å»º Large Addon**
   - Name: `Sora AI - Large Credit Pack`
   - Description: `å¤§é¢å……å€¼åŒ…ï¼Œ5000ç§¯åˆ†`
   - Pricing model: `One time`
   - Price: `$100.00 USD` / `Â¥700.00 CNY`

#### æ­¥éª¤3ï¼šå¤åˆ¶ Price IDs

åˆ›å»ºå®Œæˆåï¼Œç‚¹å‡»æ¯ä¸ªä»·æ ¼ï¼Œå¤åˆ¶ Price IDï¼ˆæ ¼å¼ï¼š`price_xxx`ï¼‰

### 4.2 ç¯å¢ƒå˜é‡é…ç½®

**æ–‡ä»¶ï¼š** `.env.local`

```env
# ============================================
# Stripe é…ç½® v2.0
# ============================================

# Stripe å¯†é’¥
STRIPE_SECRET_KEY=sk_test_xxx
NEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY=pk_test_xxx
STRIPE_WEBHOOK_SECRET=whsec_xxx

# è®¢é˜…ä»·æ ¼ ID - Starter
STRIPE_PRICE_ID_STARTER_MONTHLY_USD=price_xxx
STRIPE_PRICE_ID_STARTER_ANNUAL_USD=price_xxx
STRIPE_PRICE_ID_STARTER_MONTHLY_CNY=price_xxx
STRIPE_PRICE_ID_STARTER_ANNUAL_CNY=price_xxx

# è®¢é˜…ä»·æ ¼ ID - Premium
STRIPE_PRICE_ID_PREMIUM_MONTHLY_USD=price_xxx
STRIPE_PRICE_ID_PREMIUM_ANNUAL_USD=price_xxx
STRIPE_PRICE_ID_PREMIUM_MONTHLY_CNY=price_xxx
STRIPE_PRICE_ID_PREMIUM_ANNUAL_CNY=price_xxx

# è®¢é˜…ä»·æ ¼ ID - Advanced
STRIPE_PRICE_ID_ADVANCED_MONTHLY_USD=price_xxx
STRIPE_PRICE_ID_ADVANCED_ANNUAL_USD=price_xxx
STRIPE_PRICE_ID_ADVANCED_MONTHLY_CNY=price_xxx
STRIPE_PRICE_ID_ADVANCED_ANNUAL_CNY=price_xxx

# å……å€¼åŒ…ä»·æ ¼ ID
STRIPE_PRICE_ID_ADDON_SMALL_USD=price_xxx
STRIPE_PRICE_ID_ADDON_SMALL_CNY=price_xxx
STRIPE_PRICE_ID_ADDON_LARGE_USD=price_xxx
STRIPE_PRICE_ID_ADDON_LARGE_CNY=price_xxx

# å®šæ—¶ä»»åŠ¡å¯†é’¥
CRON_SECRET=your-random-secret-here
```

**æ–‡ä»¶ï¼š** `.env.example`ï¼ˆåŒæ ·æ·»åŠ è¿™äº›å˜é‡ï¼Œä½†å€¼ç”¨å ä½ç¬¦ï¼‰

### 4.3 åˆ›å»ºä»·æ ¼IDæ˜ å°„å·¥å…·

**æ–‡ä»¶ï¼š** `lib/payment/stripe-prices.ts`

```typescript
import { SubscriptionPlan, BillingCycle } from './types';

// Stripe Price ID æ˜ å°„
export const STRIPE_PRICE_IDS = {
  subscription: {
    starter: {
      monthly: {
        usd: process.env.STRIPE_PRICE_ID_STARTER_MONTHLY_USD!,
        cny: process.env.STRIPE_PRICE_ID_STARTER_MONTHLY_CNY!,
      },
      annual: {
        usd: process.env.STRIPE_PRICE_ID_STARTER_ANNUAL_USD!,
        cny: process.env.STRIPE_PRICE_ID_STARTER_ANNUAL_CNY!,
      },
    },
    premium: {
      monthly: {
        usd: process.env.STRIPE_PRICE_ID_PREMIUM_MONTHLY_USD!,
        cny: process.env.STRIPE_PRICE_ID_PREMIUM_MONTHLY_CNY!,
      },
      annual: {
        usd: process.env.STRIPE_PRICE_ID_PREMIUM_ANNUAL_USD!,
        cny: process.env.STRIPE_PRICE_ID_PREMIUM_ANNUAL_CNY!,
      },
    },
    advanced: {
      monthly: {
        usd: process.env.STRIPE_PRICE_ID_ADVANCED_MONTHLY_USD!,
        cny: process.env.STRIPE_PRICE_ID_ADVANCED_MONTHLY_CNY!,
      },
      annual: {
        usd: process.env.STRIPE_PRICE_ID_ADVANCED_ANNUAL_USD!,
        cny: process.env.STRIPE_PRICE_ID_ADVANCED_ANNUAL_CNY!,
      },
    },
  },
  addon: {
    'small-addon': {
      usd: process.env.STRIPE_PRICE_ID_ADDON_SMALL_USD!,
      cny: process.env.STRIPE_PRICE_ID_ADDON_SMALL_CNY!,
    },
    'large-addon': {
      usd: process.env.STRIPE_PRICE_ID_ADDON_LARGE_USD!,
      cny: process.env.STRIPE_PRICE_ID_ADDON_LARGE_CNY!,
    },
  },
};

// è¾…åŠ©å‡½æ•°ï¼šè·å–è®¢é˜…ä»·æ ¼ID
export function getSubscriptionPriceId(
  planType: SubscriptionPlan,
  billingCycle: BillingCycle,
  currency: 'usd' | 'cny'
): string {
  return STRIPE_PRICE_IDS.subscription[planType][billingCycle][currency];
}

// è¾…åŠ©å‡½æ•°ï¼šè·å–å……å€¼åŒ…ä»·æ ¼ID
export function getAddonPriceId(addonId: string, currency: 'usd' | 'cny'): string {
  return STRIPE_PRICE_IDS.addon[addonId as keyof typeof STRIPE_PRICE_IDS.addon][currency];
}
```

### 4.4 æµ‹è¯•æ£€æŸ¥ç‚¹ âœ“

**æµ‹è¯•æ­¥éª¤ï¼š**

1. **éªŒè¯ Stripe äº§å“åˆ›å»º**
   - åœ¨ Stripe Dashboard çš„ Products é¡µé¢æŸ¥çœ‹æ‰€æœ‰äº§å“
   - ç¡®è®¤æ¯ä¸ªäº§å“æœ‰æ­£ç¡®çš„ä»·æ ¼
   - ç¡®è®¤æè¿°å’Œå…ƒæ•°æ®æ­£ç¡®

2. **æµ‹è¯•ä»·æ ¼ID**
   åˆ›å»ºæµ‹è¯•è„šæœ¬ `test-stripe-prices.js`ï¼š
   ```javascript
   require('dotenv').config({ path: '.env.local' });
   const { STRIPE_PRICE_IDS } = require('./lib/payment/stripe-prices.ts');

   console.log('=== è®¢é˜…ä»·æ ¼ IDs ===');
   console.log('Starter Monthly USD:', STRIPE_PRICE_IDS.subscription.starter.monthly.usd);
   console.log('Premium Annual CNY:', STRIPE_PRICE_IDS.subscription.premium.annual.cny);

   console.log('\n=== å……å€¼åŒ…ä»·æ ¼ IDs ===');
   console.log('Small Addon USD:', STRIPE_PRICE_IDS.addon['small-addon'].usd);
   ```

3. **ä½¿ç”¨ Stripe CLI æµ‹è¯• Webhook**
   ```bash
   # å®‰è£… Stripe CLI
   # Windows: https://github.com/stripe/stripe-cli/releases

   # ç™»å½•
   stripe login

   # ç›‘å¬ webhook äº‹ä»¶
   stripe listen --forward-to localhost:3000/api/subscription/webhook

   # è§¦å‘æµ‹è¯•äº‹ä»¶
   stripe trigger customer.subscription.created
   stripe trigger invoice.payment_succeeded
   ```

**é¢„æœŸç»“æœï¼š**
- âœ… æ‰€æœ‰ Stripe äº§å“åˆ›å»ºæˆåŠŸ
- âœ… ä»·æ ¼ ID æ­£ç¡®é…ç½®åˆ°ç¯å¢ƒå˜é‡
- âœ… ä»·æ ¼IDæ˜ å°„å‡½æ•°å·¥ä½œæ­£å¸¸
- âœ… Stripe CLI å¯ä»¥è§¦å‘ webhook äº‹ä»¶

---

## ğŸ”Œ ç¬¬äº”é˜¶æ®µï¼šåç«¯æœåŠ¡å±‚

**ç›®æ ‡ï¼š** åˆ›å»ºè®¢é˜…ç›¸å…³çš„ API å’ŒæœåŠ¡

**æ—¶é—´ä¼°è®¡ï¼š** 2å¤©

**å¯ç‹¬ç«‹æµ‹è¯•ï¼š** âœ… æ˜¯ï¼ˆé€šè¿‡ API æµ‹è¯•å·¥å…·ï¼‰

### 5.1 åˆ›å»ºè®¢é˜…æœåŠ¡å±‚

**æ–‡ä»¶ï¼š** `lib/payment/subscription-service.ts`

```typescript
import Stripe from 'stripe';
import { createClient } from '@supabase/supabase-js';
import {
  SubscriptionPlan,
  BillingCycle,
  Subscription,
  getSubscriptionPlan,
} from './types';
import { getSubscriptionPriceId } from './stripe-prices';

const stripe = new Stripe(process.env.STRIPE_SECRET_KEY!, {
  apiVersion: '2024-12-18.acacia',
});

const supabase = createClient(
  process.env.NEXT_PUBLIC_SUPABASE_URL!,
  process.env.SUPABASE_SERVICE_ROLE_KEY!
);

// åˆ›å»ºè®¢é˜…ç»“è´¦ä¼šè¯
export async function createSubscriptionCheckout(params: {
  userId: string;
  planType: SubscriptionPlan;
  billingCycle: BillingCycle;
  currency: 'usd' | 'cny';
  locale: string;
  successUrl: string;
  cancelUrl: string;
}) {
  const { userId, planType, billingCycle, currency, locale, successUrl, cancelUrl } = params;

  // è·å–å¥—é¤ä¿¡æ¯
  const plan = getSubscriptionPlan(planType);
  if (!plan) {
    throw new Error(`Invalid plan type: ${planType}`);
  }

  // è·å–ä»·æ ¼ID
  const priceId = getSubscriptionPriceId(planType, billingCycle, currency);

  // è·å–æˆ–åˆ›å»º Stripe å®¢æˆ·
  const { data: profile } = await supabase
    .from('user_profiles')
    .select('email')
    .eq('id', userId)
    .single();

  if (!profile) {
    throw new Error('User profile not found');
  }

  // æ£€æŸ¥æ˜¯å¦å·²æœ‰ customer
  let customerId: string | undefined;
  const { data: existingSubscription } = await supabase
    .from('subscriptions')
    .select('stripe_customer_id')
    .eq('user_id', userId)
    .single();

  if (existingSubscription?.stripe_customer_id) {
    customerId = existingSubscription.stripe_customer_id;
  }

  // åˆ›å»º Stripe Checkout Session
  const session = await stripe.checkout.sessions.create({
    mode: 'subscription',
    customer: customerId,
    customer_email: customerId ? undefined : profile.email,
    line_items: [
      {
        price: priceId,
        quantity: 1,
      },
    ],
    success_url: successUrl,
    cancel_url: cancelUrl,
    locale: locale as Stripe.Checkout.SessionCreateParams.Locale,
    metadata: {
      user_id: userId,
      plan_type: planType,
      billing_cycle: billingCycle,
      monthly_credits: plan.monthlyCredits.toString(),
    },
    subscription_data: {
      metadata: {
        user_id: userId,
        plan_type: planType,
        billing_cycle: billingCycle,
      },
    },
  });

  return { sessionId: session.id, url: session.url };
}

// å¤„ç†è®¢é˜…åˆ›å»º/æ›´æ–° webhook
export async function handleSubscriptionWebhook(
  subscription: Stripe.Subscription,
  eventType: string
) {
  const userId = subscription.metadata.user_id;
  const planType = subscription.metadata.plan_type as SubscriptionPlan;
  const billingCycle = subscription.metadata.billing_cycle as BillingCycle;

  if (!userId || !planType) {
    throw new Error('Missing metadata in subscription');
  }

  const plan = getSubscriptionPlan(planType);
  if (!plan) {
    throw new Error(`Invalid plan type: ${planType}`);
  }

  // ç¡®å®šçŠ¶æ€
  let status: Subscription['status'];
  if (subscription.status === 'active') status = 'active';
  else if (subscription.status === 'canceled') status = 'cancelled';
  else if (subscription.status === 'past_due') status = 'past_due';
  else if (subscription.status === 'paused') status = 'paused';
  else if (subscription.status === 'trialing') status = 'trialing';
  else status = 'cancelled';

  // è°ƒç”¨æ•°æ®åº“å‡½æ•°åˆ›å»ºæˆ–æ›´æ–°è®¢é˜…
  const { data, error } = await supabase.rpc('upsert_subscription', {
    p_user_id: userId,
    p_plan_type: planType,
    p_billing_cycle: billingCycle || 'monthly',
    p_stripe_subscription_id: subscription.id,
    p_stripe_customer_id: subscription.customer as string,
    p_stripe_price_id: subscription.items.data[0].price.id,
    p_current_period_start: new Date(subscription.current_period_start * 1000).toISOString(),
    p_current_period_end: new Date(subscription.current_period_end * 1000).toISOString(),
    p_monthly_credits: plan.monthlyCredits,
  });

  if (error) {
    console.error('Error upserting subscription:', error);
    throw error;
  }

  return data;
}

// å¤„ç†å‘ç¥¨æ”¯ä»˜æˆåŠŸ webhookï¼ˆæœˆåº¦ç»­è®¢ï¼‰
export async function handleInvoicePaymentSucceeded(invoice: Stripe.Invoice) {
  if (!invoice.subscription) return;

  const subscriptionId = invoice.subscription as string;

  // è·å–è®¢é˜…ä¿¡æ¯
  const subscription = await stripe.subscriptions.retrieve(subscriptionId);

  // é‡ç½®ç”¨æˆ·ç§¯åˆ†
  const userId = subscription.metadata.user_id;
  if (userId) {
    const { error } = await supabase.rpc('reset_user_subscription_credits', {
      p_user_id: userId,
    });

    if (error) {
      console.error('Error resetting credits:', error);
    }
  }
}

// å–æ¶ˆè®¢é˜…
export async function cancelSubscription(
  subscriptionId: string,
  cancelAtPeriodEnd: boolean = true
) {
  // æ›´æ–° Stripe è®¢é˜…
  const subscription = await stripe.subscriptions.update(subscriptionId, {
    cancel_at_period_end: cancelAtPeriodEnd,
  });

  // æ›´æ–°æ•°æ®åº“
  const { data, error } = await supabase.rpc('cancel_subscription', {
    p_subscription_id: subscription.id,
    p_cancel_at_period_end: cancelAtPeriodEnd,
  });

  if (error) {
    throw error;
  }

  return subscription;
}

// è·å–ç”¨æˆ·è®¢é˜…çŠ¶æ€
export async function getUserSubscription(userId: string): Promise<Subscription | null> {
  const { data, error } = await supabase
    .from('subscriptions')
    .select('*')
    .eq('user_id', userId)
    .eq('status', 'active')
    .single();

  if (error || !data) {
    return null;
  }

  return data as Subscription;
}
```

### 5.2 åˆ›å»º API è·¯ç”±

#### API 1: åˆ›å»ºè®¢é˜…ç»“è´¦

**æ–‡ä»¶ï¼š** `app/api/subscription/create-session/route.ts`

```typescript
import { NextRequest, NextResponse } from 'next/server';
import { createClient } from '@supabase/supabase-js';
import { createSubscriptionCheckout } from '@/lib/payment/subscription-service';
import { CreateSubscriptionCheckoutRequest } from '@/lib/payment/types';

const supabase = createClient(
  process.env.NEXT_PUBLIC_SUPABASE_URL!,
  process.env.SUPABASE_SERVICE_ROLE_KEY!
);

export async function POST(request: NextRequest) {
  try {
    // éªŒè¯ç”¨æˆ·èº«ä»½
    const authHeader = request.headers.get('authorization');
    if (!authHeader) {
      return NextResponse.json({ error: 'Unauthorized' }, { status: 401 });
    }

    const token = authHeader.replace('Bearer ', '');
    const {
      data: { user },
      error: authError,
    } = await supabase.auth.getUser(token);

    if (authError || !user) {
      return NextResponse.json({ error: 'Invalid token' }, { status: 401 });
    }

    // è§£æè¯·æ±‚
    const body: CreateSubscriptionCheckoutRequest = await request.json();
    const { planType, billingCycle, currency, locale } = body;

    // éªŒè¯å‚æ•°
    if (!planType || !billingCycle || !currency || !locale) {
      return NextResponse.json({ error: 'Missing required parameters' }, { status: 400 });
    }

    // åˆ›å»ºç»“è´¦ä¼šè¯
    const { sessionId, url } = await createSubscriptionCheckout({
      userId: user.id,
      planType,
      billingCycle,
      currency,
      locale,
      successUrl: `${process.env.NEXT_PUBLIC_APP_URL}/account/subscription?success=true`,
      cancelUrl: `${process.env.NEXT_PUBLIC_APP_URL}/pricing?cancelled=true`,
    });

    return NextResponse.json({
      sessionId,
      url,
    });
  } catch (error) {
    console.error('Error creating subscription checkout:', error);
    return NextResponse.json(
      { error: 'Failed to create checkout session' },
      { status: 500 }
    );
  }
}
```

#### API 2: è®¢é˜… Webhook

**æ–‡ä»¶ï¼š** `app/api/subscription/webhook/route.ts`

```typescript
import { NextRequest, NextResponse } from 'next/server';
import Stripe from 'stripe';
import { headers } from 'next/headers';
import {
  handleSubscriptionWebhook,
  handleInvoicePaymentSucceeded,
} from '@/lib/payment/subscription-service';

const stripe = new Stripe(process.env.STRIPE_SECRET_KEY!, {
  apiVersion: '2024-12-18.acacia',
});

const webhookSecret = process.env.STRIPE_WEBHOOK_SECRET_SUBSCRIPTION!;

export async function POST(request: NextRequest) {
  const body = await request.text();
  const signature = headers().get('stripe-signature');

  if (!signature) {
    return NextResponse.json({ error: 'Missing signature' }, { status: 400 });
  }

  let event: Stripe.Event;

  try {
    event = stripe.webhooks.constructEvent(body, signature, webhookSecret);
  } catch (err) {
    console.error('Webhook signature verification failed:', err);
    return NextResponse.json({ error: 'Invalid signature' }, { status: 400 });
  }

  try {
    switch (event.type) {
      case 'customer.subscription.created':
      case 'customer.subscription.updated':
        await handleSubscriptionWebhook(event.data.object as Stripe.Subscription, event.type);
        break;

      case 'customer.subscription.deleted':
        // TODO: å¤„ç†è®¢é˜…åˆ é™¤
        break;

      case 'invoice.payment_succeeded':
        await handleInvoicePaymentSucceeded(event.data.object as Stripe.Invoice);
        break;

      case 'invoice.payment_failed':
        // TODO: å¤„ç†æ”¯ä»˜å¤±è´¥
        break;

      default:
        console.log(`Unhandled event type: ${event.type}`);
    }

    return NextResponse.json({ received: true });
  } catch (error) {
    console.error('Error processing webhook:', error);
    return NextResponse.json({ error: 'Webhook processing failed' }, { status: 500 });
  }
}
```

#### API 3: è·å–è®¢é˜…çŠ¶æ€

**æ–‡ä»¶ï¼š** `app/api/subscription/status/route.ts`

```typescript
import { NextRequest, NextResponse } from 'next/server';
import { createClient } from '@supabase/supabase-js';
import { getUserSubscription } from '@/lib/payment/subscription-service';

const supabase = createClient(
  process.env.NEXT_PUBLIC_SUPABASE_URL!,
  process.env.SUPABASE_SERVICE_ROLE_KEY!
);

export async function GET(request: NextRequest) {
  try {
    const authHeader = request.headers.get('authorization');
    if (!authHeader) {
      return NextResponse.json({ error: 'Unauthorized' }, { status: 401 });
    }

    const token = authHeader.replace('Bearer ', '');
    const {
      data: { user },
      error: authError,
    } = await supabase.auth.getUser(token);

    if (authError || !user) {
      return NextResponse.json({ error: 'Invalid token' }, { status: 401 });
    }

    const subscription = await getUserSubscription(user.id);

    if (!subscription) {
      return NextResponse.json({ subscription: null, planTier: 'free' });
    }

    return NextResponse.json({ subscription });
  } catch (error) {
    console.error('Error getting subscription status:', error);
    return NextResponse.json({ error: 'Failed to get subscription' }, { status: 500 });
  }
}
```

#### API 4: å–æ¶ˆè®¢é˜…

**æ–‡ä»¶ï¼š** `app/api/subscription/cancel/route.ts`

```typescript
import { NextRequest, NextResponse } from 'next/server';
import { createClient } from '@supabase/supabase-js';
import { cancelSubscription, getUserSubscription } from '@/lib/payment/subscription-service';

const supabase = createClient(
  process.env.NEXT_PUBLIC_SUPABASE_URL!,
  process.env.SUPABASE_SERVICE_ROLE_KEY!
);

export async function POST(request: NextRequest) {
  try {
    const authHeader = request.headers.get('authorization');
    if (!authHeader) {
      return NextResponse.json({ error: 'Unauthorized' }, { status: 401 });
    }

    const token = authHeader.replace('Bearer ', '');
    const {
      data: { user },
      error: authError,
    } = await supabase.auth.getUser(token);

    if (authError || !user) {
      return NextResponse.json({ error: 'Invalid token' }, { status: 401 });
    }

    // è·å–ç”¨æˆ·è®¢é˜…
    const subscription = await getUserSubscription(user.id);
    if (!subscription) {
      return NextResponse.json({ error: 'No active subscription' }, { status: 404 });
    }

    // å–æ¶ˆè®¢é˜…ï¼ˆå‘¨æœŸç»“æŸæ—¶ï¼‰
    await cancelSubscription(subscription.stripe_subscription_id, true);

    return NextResponse.json({ success: true });
  } catch (error) {
    console.error('Error cancelling subscription:', error);
    return NextResponse.json({ error: 'Failed to cancel subscription' }, { status: 500 });
  }
}
```

### 5.3 æµ‹è¯•æ£€æŸ¥ç‚¹ âœ“

**æµ‹è¯•æ­¥éª¤ï¼š**

1. **å¯åŠ¨å¼€å‘æœåŠ¡å™¨**
   ```bash
   npm run dev
   ```

2. **ä½¿ç”¨ curl æµ‹è¯• API**

   **æµ‹è¯•åˆ›å»ºè®¢é˜…ï¼š**
   ```bash
   curl -X POST http://localhost:3000/api/subscription/create-session \
     -H "Content-Type: application/json" \
     -H "Authorization: Bearer YOUR_TOKEN" \
     -d '{
       "planType": "premium",
       "billingCycle": "monthly",
       "currency": "usd",
       "locale": "en"
     }'
   ```

   **æµ‹è¯•è·å–çŠ¶æ€ï¼š**
   ```bash
   curl -X GET http://localhost:3000/api/subscription/status \
     -H "Authorization: Bearer YOUR_TOKEN"
   ```

3. **ä½¿ç”¨ Stripe CLI æµ‹è¯• Webhook**
   ```bash
   stripe listen --forward-to localhost:3000/api/subscription/webhook

   # åœ¨å¦ä¸€ä¸ªç»ˆç«¯è§¦å‘äº‹ä»¶
   stripe trigger customer.subscription.created
   ```

4. **ä½¿ç”¨ Postman æµ‹è¯•**
   - å¯¼å…¥ API ç«¯ç‚¹
   - è®¾ç½® Authorization header
   - å‘é€è¯·æ±‚å¹¶éªŒè¯å“åº”

**é¢„æœŸç»“æœï¼š**
- âœ… åˆ›å»ºè®¢é˜… API è¿”å› Stripe Checkout URL
- âœ… è·å–çŠ¶æ€ API è¿”å›è®¢é˜…ä¿¡æ¯
- âœ… Webhook æ­£ç¡®å¤„ç† Stripe äº‹ä»¶
- âœ… æ•°æ®åº“æ­£ç¡®æ›´æ–°è®¢é˜…è®°å½•

---

## ğŸ¨ ç¬¬å…­é˜¶æ®µï¼šå‰ç«¯ç»„ä»¶

**ç›®æ ‡ï¼š** åˆ›å»ºå®šä»·é¡µé¢å’Œè®¢é˜…ç®¡ç† UI

**æ—¶é—´ä¼°è®¡ï¼š** 3å¤©

**å¯ç‹¬ç«‹æµ‹è¯•ï¼š** âœ… æ˜¯ï¼ˆæµè§ˆå™¨é¢„è§ˆï¼‰

### 6.1 åˆ›å»ºå®šä»·é¡µé¢

**æ–‡ä»¶ï¼š** `app/pricing/page.tsx`

```typescript
import { Metadata } from 'next';
import PricingPage from '@/components/pricing/PricingPage';

export const metadata: Metadata = {
  title: 'Pricing - Sora AI',
  description: 'Choose the perfect plan for your needs',
};

export default function Pricing() {
  return <PricingPage />;
}
```

**æ–‡ä»¶ï¼š** `components/pricing/PricingPage.tsx`

```typescript
'use client';

import { useState } from 'react';
import { SUBSCRIPTION_PLANS, ADDON_PACKAGES } from '@/lib/payment/types';
import SubscriptionCard from './SubscriptionCard';
import AddonCard from './AddonCard';
import BillingToggle from './BillingToggle';

export default function PricingPage() {
  const [billingCycle, setBillingCycle] = useState<'monthly' | 'annual'>('monthly');

  return (
    <div className="min-h-screen bg-gradient-to-b from-slate-900 to-slate-800 py-12 px-4">
      {/* æ ‡é¢˜éƒ¨åˆ† */}
      <div className="max-w-7xl mx-auto text-center mb-12">
        <h1 className="text-4xl md:text-5xl font-bold text-white mb-4">
          Sora 2 AI for Every Creator
        </h1>

        {/* è®¡è´¹åˆ‡æ¢ */}
        <BillingToggle
          billingCycle={billingCycle}
          onToggle={setBillingCycle}
        />

        <p className="text-slate-300 mt-4">
          Pay for 1 month, Cancel anytime.
        </p>
      </div>

      {/* è®¢é˜…å¥—é¤ */}
      <div className="max-w-7xl mx-auto mb-16">
        <div className="grid grid-cols-1 md:grid-cols-3 gap-8">
          {SUBSCRIPTION_PLANS.map((plan) => (
            <SubscriptionCard
              key={plan.id}
              plan={plan}
              billingCycle={billingCycle}
              isPopular={plan.isPopular}
            />
          ))}
        </div>
      </div>

      {/* å……å€¼åŒ… */}
      <div className="max-w-7xl mx-auto">
        <h2 className="text-3xl font-bold text-white text-center mb-8">
          One-Time Credit Packs
        </h2>
        <div className="grid grid-cols-1 md:grid-cols-2 gap-8 max-w-4xl mx-auto">
          {ADDON_PACKAGES.map((addon) => (
            <AddonCard key={addon.id} addon={addon} />
          ))}
        </div>
      </div>
    </div>
  );
}
```

### 6.2 åˆ›å»ºç»„ä»¶æ–‡ä»¶

ç”±äºç¯‡å¹…é™åˆ¶ï¼Œä»¥ä¸‹æ˜¯æ ¸å¿ƒç»„ä»¶çš„ç»“æ„ï¼š

**SubscriptionCard.tsx** - è®¢é˜…å¡ç‰‡
**AddonCard.tsx** - å……å€¼å¡ç‰‡
**BillingToggle.tsx** - è®¡è´¹å‘¨æœŸåˆ‡æ¢

ï¼ˆå®Œæ•´ç»„ä»¶ä»£ç è§æ–‡æ¡£æœ«å°¾é™„å½•ï¼‰

### 6.3 æµ‹è¯•æ£€æŸ¥ç‚¹ âœ“

**æµ‹è¯•æ­¥éª¤ï¼š**

1. **å¯åŠ¨å¼€å‘æœåŠ¡å™¨**
   ```bash
   npm run dev
   ```

2. **æµè§ˆå™¨è®¿é—®**
   ```
   http://localhost:3000/pricing
   ```

3. **æµ‹è¯•äº¤äº’**
   - âœ… æœˆä»˜/å¹´ä»˜åˆ‡æ¢æ­£å¸¸
   - âœ… ä»·æ ¼æ˜¾ç¤ºæ­£ç¡®åˆ‡æ¢
   - âœ… "æœ€å—æ¬¢è¿"æ ‡ç­¾æ˜¾ç¤º
   - âœ… ç‚¹å‡»æŒ‰é’®è§¦å‘æ”¯ä»˜æµç¨‹
   - âœ… å“åº”å¼å¸ƒå±€åœ¨ç§»åŠ¨ç«¯æ­£å¸¸

4. **æµ‹è¯•æ”¯ä»˜æµç¨‹**
   - ç‚¹å‡»"è´­ä¹°å¥—é¤"æŒ‰é’®
   - éªŒè¯è·³è½¬åˆ° Stripe Checkout
   - ä½¿ç”¨æµ‹è¯•å¡å·å®Œæˆæ”¯ä»˜
   - éªŒè¯é‡å®šå‘å›ç½‘ç«™

**é¢„æœŸç»“æœï¼š**
- âœ… UI æ¸²æŸ“æ­£å¸¸
- âœ… äº¤äº’æµç•…
- âœ… æ”¯ä»˜æµç¨‹å®Œæ•´
- âœ… ç§»åŠ¨ç«¯é€‚é…è‰¯å¥½

---

## ğŸ§ª ç¬¬ä¸ƒé˜¶æ®µï¼šé›†æˆæµ‹è¯•

**ç›®æ ‡ï¼š** ç«¯åˆ°ç«¯æµ‹è¯•å®Œæ•´æµç¨‹

**æ—¶é—´ä¼°è®¡ï¼š** 1å¤©

**å¯ç‹¬ç«‹æµ‹è¯•ï¼š** âœ… æ˜¯

### 7.1 æµ‹è¯•åœºæ™¯æ¸…å•

#### åœºæ™¯1ï¼šæ–°ç”¨æˆ·è®¢é˜…æµç¨‹
```
1. ç”¨æˆ·è®¿é—® /pricing
2. é€‰æ‹© Premium æœˆä»˜å¥—é¤
3. ç‚¹å‡»"è´­ä¹°å¥—é¤"
4. è·³è½¬åˆ° Stripe Checkout
5. å®Œæˆæ”¯ä»˜ï¼ˆæµ‹è¯•å¡ï¼‰
6. é‡å®šå‘å› /account/subscription
7. éªŒè¯ï¼š
   - è®¢é˜…çŠ¶æ€ä¸º active
   - ç§¯åˆ†ä½™é¢ä¸º 2000
   - plan_tier ä¸º premium
   - æ•°æ®åº“ subscriptions è¡¨æœ‰è®°å½•
```

#### åœºæ™¯2ï¼šç§¯åˆ†æ¶ˆè´¹ä¼˜å…ˆçº§
```
1. ç”¨æˆ·æœ‰è®¢é˜…ç§¯åˆ† 100 å’Œæ™®é€šç§¯åˆ† 50
2. å¤„ç†è§†é¢‘æ¶ˆè€— 1 ç§¯åˆ†
3. éªŒè¯ï¼šè®¢é˜…ç§¯åˆ†å˜ä¸º 99ï¼Œæ™®é€šç§¯åˆ†ä»ä¸º 50
4. ç»§ç»­æ¶ˆè€—è‡³è®¢é˜…ç§¯åˆ†ä¸º 0
5. å†æ¬¡æ¶ˆè€—
6. éªŒè¯ï¼šè®¢é˜…ç§¯åˆ†ä¸º 0ï¼Œæ™®é€šç§¯åˆ†å˜ä¸º 49
```

#### åœºæ™¯3ï¼šæœˆåº¦ç§¯åˆ†é‡ç½®
```
1. ç”¨æˆ·è®¢é˜…å·²è¿‡å‘¨æœŸç»“æŸæ—¶é—´
2. è¿è¡Œå®šæ—¶ä»»åŠ¡æˆ–æ‰‹åŠ¨è°ƒç”¨å‡½æ•°
3. éªŒè¯ï¼šsubscription_credits é‡ç½®ä¸º monthly_credits
```

#### åœºæ™¯4ï¼šå–æ¶ˆè®¢é˜…
```
1. ç”¨æˆ·è®¿é—® /account/subscription
2. ç‚¹å‡»"å–æ¶ˆè®¢é˜…"
3. ç¡®è®¤å–æ¶ˆï¼ˆå‘¨æœŸç»“æŸæ—¶ï¼‰
4. éªŒè¯ï¼š
   - cancel_at_period_end ä¸º true
   - è®¢é˜…ä»ç„¶ active
   - ç§¯åˆ†ä»å¯ä½¿ç”¨
5. ç­‰å¾…å‘¨æœŸç»“æŸ
6. éªŒè¯ï¼š
   - è®¢é˜…çŠ¶æ€å˜ä¸º cancelled
   - plan_tier å˜ä¸º free
```

### 7.2 æµ‹è¯•è„šæœ¬

**æ–‡ä»¶ï¼š** `tests/subscription-flow.test.ts`

```typescript
import { describe, it, expect } from '@jest/globals';
import { createClient } from '@supabase/supabase-js';

const supabase = createClient(
  process.env.NEXT_PUBLIC_SUPABASE_URL!,
  process.env.SUPABASE_SERVICE_ROLE_KEY!
);

describe('Subscription Flow', () => {
  const TEST_USER_ID = 'test-user-id'; // æ›¿æ¢ä¸ºå®é™…æµ‹è¯•ç”¨æˆ·ID

  it('should consume subscription credits first', async () => {
    // è®¾ç½®åˆå§‹ç§¯åˆ†
    await supabase
      .from('user_profiles')
      .update({ subscription_credits: 100, credits: 50 })
      .eq('id', TEST_USER_ID);

    // æ¶ˆè´¹ç§¯åˆ†
    const { data } = await supabase.rpc('consume_credit_v2', {
      p_user_id: TEST_USER_ID,
    });

    expect(data[0].credit_type).toBe('subscription');
    expect(data[0].remaining_subscription_credits).toBe(99);
    expect(data[0].remaining_regular_credits).toBe(50);
  });

  it('should reset subscription credits', async () => {
    // TODO: å®ç°é‡ç½®æµ‹è¯•
  });

  // æ›´å¤šæµ‹è¯•...
});
```

### 7.3 æ‰‹åŠ¨æµ‹è¯•æ£€æŸ¥è¡¨

**æ‰“å°æ­¤æ¸…å•å¹¶é€é¡¹æµ‹è¯•ï¼š**

- [ ] è®¿é—®å®šä»·é¡µé¢ï¼ŒUI æ¸²æŸ“æ­£å¸¸
- [ ] åˆ‡æ¢æœˆä»˜/å¹´ä»˜ï¼Œä»·æ ¼æ­£ç¡®å˜åŒ–
- [ ] ç‚¹å‡»è®¢é˜…æŒ‰é’®ï¼Œè·³è½¬åˆ° Stripe
- [ ] ä½¿ç”¨æµ‹è¯•å¡ `4242 4242 4242 4242` å®Œæˆæ”¯ä»˜
- [ ] æ”¯ä»˜æˆåŠŸåé‡å®šå‘å›ç½‘ç«™
- [ ] åœ¨è´¦æˆ·é¡µé¢çœ‹åˆ°è®¢é˜…çŠ¶æ€
- [ ] ç§¯åˆ†æ˜¾ç¤ºæ­£ç¡®ï¼ˆè®¢é˜…ç§¯åˆ† + æ™®é€šç§¯åˆ†ï¼‰
- [ ] å¤„ç†è§†é¢‘ï¼Œç§¯åˆ†æ­£ç¡®æ‰£é™¤
- [ ] å–æ¶ˆè®¢é˜…ï¼Œç¡®è®¤å‘¨æœŸç»“æŸæ—¶å–æ¶ˆ
- [ ] è´­ä¹°å……å€¼åŒ…ï¼Œç§¯åˆ†å¢åŠ åˆ°æ™®é€šç§¯åˆ†
- [ ] è®¢é˜…è¿‡æœŸåï¼Œç§¯åˆ†é‡ç½®
- [ ] Webhook äº‹ä»¶æ­£ç¡®å¤„ç†

---

## ğŸ“š é™„å½•

### A. Stripe æµ‹è¯•å¡å·

| åœºæ™¯ | å¡å· | è¿‡æœŸæ—¥æœŸ | CVC | é‚®ç¼– |
|------|------|---------|-----|------|
| æˆåŠŸæ”¯ä»˜ | 4242 4242 4242 4242 | ä»»æ„æœªæ¥æ—¥æœŸ | ä»»æ„3ä½ | ä»»æ„ |
| æ”¯ä»˜å¤±è´¥ | 4000 0000 0000 0002 | ä»»æ„æœªæ¥æ—¥æœŸ | ä»»æ„3ä½ | ä»»æ„ |
| éœ€è¦3DéªŒè¯ | 4000 0025 0000 3155 | ä»»æ„æœªæ¥æ—¥æœŸ | ä»»æ„3ä½ | ä»»æ„ |

### B. å®šæ—¶ä»»åŠ¡é…ç½®

**æ–‡ä»¶ï¼š** `vercel.json`

```json
{
  "crons": [
    {
      "path": "/api/cron/reset-credits",
      "schedule": "0 0 * * *"
    }
  ]
}
```

**æ–‡ä»¶ï¼š** `app/api/cron/reset-credits/route.ts`

```typescript
import { NextRequest, NextResponse } from 'next/server';
import { createClient } from '@supabase/supabase-js';

const supabase = createClient(
  process.env.NEXT_PUBLIC_SUPABASE_URL!,
  process.env.SUPABASE_SERVICE_ROLE_KEY!
);

export async function GET(request: NextRequest) {
  // éªŒè¯ cron secret
  const authHeader = request.headers.get('authorization');
  if (authHeader !== `Bearer ${process.env.CRON_SECRET}`) {
    return NextResponse.json({ error: 'Unauthorized' }, { status: 401 });
  }

  try {
    // è°ƒç”¨ç§¯åˆ†é‡ç½®å‡½æ•°
    const { data, error } = await supabase.rpc('reset_subscription_credits');

    if (error) throw error;

    return NextResponse.json({
      success: true,
      resettedUsers: data?.length || 0,
    });
  } catch (error) {
    console.error('Error resetting credits:', error);
    return NextResponse.json({ error: 'Reset failed' }, { status: 500 });
  }
}
```

### C. ç¯å¢ƒå˜é‡å®Œæ•´æ¸…å•

```env
# Supabase
NEXT_PUBLIC_SUPABASE_URL=https://xxx.supabase.co
NEXT_PUBLIC_SUPABASE_ANON_KEY=eyJxxx
SUPABASE_SERVICE_ROLE_KEY=eyJxxx

# Stripe
STRIPE_SECRET_KEY=sk_test_xxx
NEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY=pk_test_xxx
STRIPE_WEBHOOK_SECRET=whsec_xxx

# Stripe è®¢é˜…ä»·æ ¼ ID
STRIPE_PRICE_ID_STARTER_MONTHLY_USD=price_xxx
STRIPE_PRICE_ID_STARTER_ANNUAL_USD=price_xxx
STRIPE_PRICE_ID_STARTER_MONTHLY_CNY=price_xxx
STRIPE_PRICE_ID_STARTER_ANNUAL_CNY=price_xxx
STRIPE_PRICE_ID_PREMIUM_MONTHLY_USD=price_xxx
STRIPE_PRICE_ID_PREMIUM_ANNUAL_USD=price_xxx
STRIPE_PRICE_ID_PREMIUM_MONTHLY_CNY=price_xxx
STRIPE_PRICE_ID_PREMIUM_ANNUAL_CNY=price_xxx
STRIPE_PRICE_ID_ADVANCED_MONTHLY_USD=price_xxx
STRIPE_PRICE_ID_ADVANCED_ANNUAL_USD=price_xxx
STRIPE_PRICE_ID_ADVANCED_MONTHLY_CNY=price_xxx
STRIPE_PRICE_ID_ADVANCED_ANNUAL_CNY=price_xxx

# Stripe å……å€¼åŒ…ä»·æ ¼ ID
STRIPE_PRICE_ID_ADDON_SMALL_USD=price_xxx
STRIPE_PRICE_ID_ADDON_SMALL_CNY=price_xxx
STRIPE_PRICE_ID_ADDON_LARGE_USD=price_xxx
STRIPE_PRICE_ID_ADDON_LARGE_CNY=price_xxx

# åº”ç”¨é…ç½®
NEXT_PUBLIC_APP_URL=http://localhost:3000
CRON_SECRET=your-random-secret-here
```

---

## ğŸ“ é—®é¢˜æ’æŸ¥

### é—®é¢˜1ï¼šè®¢é˜…åˆ›å»ºåç§¯åˆ†æ²¡æœ‰å¢åŠ 
**æ’æŸ¥æ­¥éª¤ï¼š**
1. æ£€æŸ¥ webhook æ˜¯å¦æ­£ç¡®è§¦å‘
2. æŸ¥çœ‹ Supabase æ—¥å¿—
3. éªŒè¯ `upsert_subscription` å‡½æ•°æ˜¯å¦æ‰§è¡Œ
4. æ£€æŸ¥ç”¨æˆ· `subscription_credits` å­—æ®µ

### é—®é¢˜2ï¼šStripe Checkout è·³è½¬å¤±è´¥
**æ’æŸ¥æ­¥éª¤ï¼š**
1. æ£€æŸ¥ Price ID æ˜¯å¦æ­£ç¡®
2. éªŒè¯ Stripe API Key
3. æŸ¥çœ‹æµè§ˆå™¨æ§åˆ¶å°é”™è¯¯
4. æ£€æŸ¥ CORS é…ç½®

### é—®é¢˜3ï¼šç§¯åˆ†æ¶ˆè´¹ä¸æ­£ç¡®
**æ’æŸ¥æ­¥éª¤ï¼š**
1. æŸ¥è¯¢å½“å‰ç”¨æˆ·ç§¯åˆ†ï¼š
   ```sql
   SELECT * FROM get_user_credits_info('user_id');
   ```
2. æµ‹è¯•æ¶ˆè´¹å‡½æ•°ï¼š
   ```sql
   SELECT * FROM consume_credit_v2('user_id');
   ```
3. æ£€æŸ¥ RLS ç­–ç•¥æ˜¯å¦é˜»æ­¢æ“ä½œ

---

## âœ… å®Œæˆæ ‡å‡†

**é˜¶æ®µ1å®Œæˆæ ‡å‡†ï¼š**
- [ ] æ‰€æœ‰è¡¨åˆ›å»ºæˆåŠŸ
- [ ] æ‰€æœ‰å­—æ®µç±»å‹æ­£ç¡®
- [ ] ç´¢å¼•åˆ›å»ºå®Œæˆ
- [ ] RLS ç­–ç•¥ç”Ÿæ•ˆ
- [ ] æµ‹è¯•æ•°æ®å¯æ’å…¥å’ŒæŸ¥è¯¢

**é˜¶æ®µ2å®Œæˆæ ‡å‡†ï¼š**
- [ ] æ‰€æœ‰å‡½æ•°åˆ›å»ºæ— é”™è¯¯
- [ ] ç§¯åˆ†é‡ç½®å‡½æ•°å·¥ä½œæ­£å¸¸
- [ ] ç§¯åˆ†æ¶ˆè´¹ä¼˜å…ˆçº§æ­£ç¡®
- [ ] è®¢é˜…åˆ›å»º/æ›´æ–°å‡½æ•°æ­£å¸¸

**é˜¶æ®µ3å®Œæˆæ ‡å‡†ï¼š**
- [ ] TypeScript ç¼–è¯‘æ— é”™è¯¯
- [ ] ç±»å‹å®šä¹‰å®Œæ•´
- [ ] é…ç½®æ•°æ®æ­£ç¡®

**é˜¶æ®µ4å®Œæˆæ ‡å‡†ï¼š**
- [ ] Stripe äº§å“åˆ›å»ºå®Œæˆ
- [ ] æ‰€æœ‰ Price ID é…ç½®åˆ°ç¯å¢ƒå˜é‡
- [ ] Webhook å¯ä»¥è§¦å‘

**é˜¶æ®µ5å®Œæˆæ ‡å‡†ï¼š**
- [ ] æ‰€æœ‰ API è·¯ç”±æ­£å¸¸å“åº”
- [ ] Webhook æ­£ç¡®å¤„ç†äº‹ä»¶
- [ ] æ•°æ®åº“æ­£ç¡®æ›´æ–°

**é˜¶æ®µ6å®Œæˆæ ‡å‡†ï¼š**
- [ ] UI æ¸²æŸ“æ­£å¸¸
- [ ] äº¤äº’æµç•…
- [ ] å“åº”å¼è®¾è®¡æ­£å¸¸

**é˜¶æ®µ7å®Œæˆæ ‡å‡†ï¼š**
- [ ] æ‰€æœ‰æµ‹è¯•åœºæ™¯é€šè¿‡
- [ ] æ‰‹åŠ¨æµ‹è¯•æ¸…å•å…¨éƒ¨å‹¾é€‰
- [ ] æ— ä¸¥é‡ bug

---

## ğŸ“ ç»“è¯­

æœ¬æ–‡æ¡£æä¾›äº†å®Œæ•´çš„è®¢é˜…ç³»ç»Ÿè¿­ä»£è®¡åˆ’ï¼Œæ¯ä¸ªé˜¶æ®µéƒ½è®¾è®¡ä¸ºå¯ç‹¬ç«‹æµ‹è¯•çš„æ¨¡å—ã€‚

**å®æ–½å»ºè®®ï¼š**
1. ä¸¥æ ¼æŒ‰ç…§é˜¶æ®µé¡ºåºè¿›è¡Œ
2. æ¯å®Œæˆä¸€ä¸ªé˜¶æ®µç«‹å³æµ‹è¯•
3. å‘ç°é—®é¢˜ç«‹å³ä¿®å¤ï¼Œä¸è¦ç§¯ç´¯
4. è®°å½•æ‰€æœ‰é‡åˆ°çš„é—®é¢˜å’Œè§£å†³æ–¹æ¡ˆ
5. ä¿æŒä¸å›¢é˜Ÿçš„æ²Ÿé€š

**é¢„è®¡æ€»æ—¶é—´ï¼š** 9-10 å¤©

**ç¥å¼€å‘é¡ºåˆ©ï¼** ğŸš€
