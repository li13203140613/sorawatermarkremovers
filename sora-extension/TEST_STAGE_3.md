# 🧪 阶段 3 测试文档：Popup UI 和完整登录流程

## ✅ 已完成

1. ✅ 更新 `popup.html` - 添加 OAuth 登录界面
2. ✅ 更新 `popup.js` - 实现登录/登出逻辑
3. ✅ 更新 `popup.css` - 添加完整样式

---

## 📋 测试前准备

### 步骤 1：确认 manifest.json 使用正确的 background script

确保 `manifest.json` 中：
```json
"background": {
  "service_worker": "background-oauth.js"
}
```

### 步骤 2：重新加载扩展

1. 打开 `chrome://extensions/`
2. 找到 "Sora Video Downloader"
3. 点击 **重新加载** 按钮（🔄）

---

## 🧪 测试步骤

### 测试 1：Popup 打开显示登录界面

**操作**：
1. 点击浏览器工具栏上的扩展图标
2. Popup 窗口打开

**预期结果**：
- ✅ 显示 Logo 和标题 "Sora Video Downloader"
- ✅ 显示副标题 "一键去除 Sora 视频水印"
- ✅ 显示 "选择登录方式："
- ✅ 显示 Google 登录按钮（带 Google 图标）
- ✅ 显示提示文字 "💡 与网站 www.sora-prompt.io 共享账号"

**截图位置**：__________

**✅ 通过 / ❌ 失败**：__________

---

### 测试 2：点击 Google 登录按钮

**前提条件**：
- 已在 Supabase 配置 Redirect URI（阶段 2 的必需步骤）

**操作**：
1. 点击 "使用 Google 登录" 按钮
2. 观察按钮状态变化
3. 观察是否弹出 Google 授权窗口

**预期结果**：
1. **按钮状态**：
   - ✅ 按钮文字变为 "登录中..."
   - ✅ 按钮被禁用（不可再次点击）

2. **Google 授权窗口**：
   - ✅ 弹出新窗口
   - ✅ 显示 Google 登录页面
   - ✅ 或显示账号选择页面（如果已登录 Google）

**✅ 通过 / ❌ 失败**：__________

---

### 测试 3：完成 Google 授权

**操作**：
1. 在 Google 授权窗口中选择账号（或登录）
2. 授权后，窗口自动关闭
3. 观察 Popup 的变化

**预期结果**：
1. **授权窗口**：
   - ✅ 授权成功后自动关闭

2. **Popup 显示**：
   - ✅ 显示加载状态（短暂）
   - ✅ 切换到已登录界面
   - ✅ 显示用户头像（或首字母头像）
   - ✅ 显示用户名（例如："李李李"）
   - ✅ 显示邮箱（例如："lixiaofei160@gmail.com"）
   - ✅ 显示积分（例如："0"）
   - ✅ 显示两个按钮："充值积分" 和 "登出"

3. **控制台日志**（按 F12 查看）：
   ```
   🎬 Popup 页面已加载
   📋 初始化 Popup
   📨 收到消息: {action: 'getUserInfo'}
   ✅ OAuth Token 有效
   📤 发送用户信息: {success: true, isLoggedIn: true, ...}
   ✅ 已登录: {id: '...', email: '...', name: '...', ...}
   ✅ Popup 初始化完成
   ```

**✅ 通过 / ❌ 失败**：__________

---

### 测试 4：验证用户信息正确性

**操作**：
检查 Popup 显示的用户信息

**验证项**：
- [ ] 用户名正确
- [ ] 邮箱正确
- [ ] 头像正确（如果有）/ 或显示首字母头像
- [ ] 积分显示为数字（0 或其他）

**✅ 通过 / ❌ 失败**：__________

---

### 测试 5：测试充值按钮

**操作**：
1. 点击 "充值积分" 按钮

**预期结果**：
- ✅ 打开新标签页
- ✅ 导航到 `https://www.sora-prompt.io/pricing`

**✅ 通过 / ❌ 失败**：__________

---

### 测试 6：测试登出功能

**操作**：
1. 点击 "登出" 按钮
2. 在确认对话框中点击 "确定"

**预期结果**：
1. **确认对话框**：
   - ✅ 弹出对话框："确定要登出吗？"

2. **登出后的 Popup**：
   - ✅ 返回登录界面
   - ✅ 显示 Google 登录按钮

3. **控制台日志**：
   ```
   👋 登出
   📨 收到消息: {action: 'logout'}
   👋 登出中...
   ✅ 已登出
   📤 登出成功
   ```

4. **存储验证**（在 background console 执行）：
   ```javascript
   chrome.storage.local.get([
     'oauth_access_token',
     'oauth_refresh_token',
     'oauth_user_info'
   ], console.log);
   ```
   **预期**：所有值都应该是 `undefined`

**✅ 通过 / ❌ 失败**：__________

---

### 测试 7：重新登录（验证可重复性）

**操作**：
1. 再次点击 "使用 Google 登录"
2. 完成授权流程

**预期结果**：
- ✅ 能够再次成功登录
- ✅ 显示用户信息
- ✅ 所有功能正常

**✅ 通过 / ❌ 失败**：__________

---

### 测试 8：关闭 Popup 再打开（验证持久化）

**操作**：
1. 关闭 Popup（点击外部区域）
2. 再次点击扩展图标打开 Popup

**预期结果**：
- ✅ 不需要重新登录
- ✅ 直接显示用户信息
- ✅ 用户名、邮箱、积分正确

**原理**：Token 存储在 `chrome.storage.local`，不会因为 Popup 关闭而丢失

**✅ 通过 / ❌ 失败**：__________

---

## 📊 测试结果汇总

| 测试项 | 状态 | 备注 |
|--------|------|------|
| 1. 登录界面显示 | ⬜ | |
| 2. 点击登录按钮 | ⬜ | |
| 3. 完成 Google 授权 | ⬜ | **核心测试** |
| 4. 用户信息正确性 | ⬜ | |
| 5. 充值按钮 | ⬜ | |
| 6. 登出功能 | ⬜ | |
| 7. 重新登录 | ⬜ | |
| 8. 持久化验证 | ⬜ | |

---

## 🐛 常见问题排查

### 问题 1：点击登录按钮没有反应

**可能原因**：
- manifest.json 还在使用旧的 background.js
- 扩展没有重新加载

**解决**：
1. 确认 manifest.json 中 `"service_worker": "background-oauth.js"`
2. 重新加载扩展
3. 打开 background service worker 控制台，查看是否有错误

---

### 问题 2：Google 授权窗口显示 "redirect_uri_mismatch"

**原因**：Supabase 的 Redirect URI 配置不正确

**解决**：
1. 检查扩展 ID 是否正确
2. 检查 Supabase Dashboard 中的 Redirect URL 格式
3. 必须是：`https://[扩展ID].chromiumapp.org/`（注意结尾的 `/`）

---

### 问题 3：登录后显示"获取用户信息失败"

**可能原因**：
- 后端 API `/api/user/profile` 可能不支持 Bearer Token
- 网络错误

**临时验证**：
在 background console 查看日志：
```
📡 获取用户信息...
❌ 获取用户信息失败: 401
```

**解决**：
- 如果看到 401 错误，说明后端 API 需要适配（下一阶段处理）
- 如果看到其他错误，检查网络连接

---

### 问题 4：Popup 样式混乱

**可能原因**：CSS 文件缓存

**解决**：
1. 强制刷新：Ctrl+Shift+R（Windows）或 Cmd+Shift+R（Mac）
2. 或者重新加载扩展

---

## ✅ 阶段完成标准

只要以下核心测试通过，就算成功：

- [x] **测试 1**：登录界面正确显示
- [x] **测试 3**：OAuth 登录流程成功
- [x] **测试 6**：登出功能正常
- [x] **测试 8**：Token 持久化正常

---

## 📝 UI 预览

### 未登录状态
```
┌─────────────────────────────┐
│    [Logo Icon]              │
│  Sora Video Downloader      │
│  一键去除 Sora 视频水印       │
│                             │
│  选择登录方式：               │
│                             │
│  ┌─────────────────────┐   │
│  │ [G] 使用 Google 登录 │   │
│  └─────────────────────┘   │
│                             │
│  💡 与网站共享账号           │
└─────────────────────────────┘
```

### 已登录状态
```
┌─────────────────────────────┐
│  [头像]  李李李              │
│         lixiaofei@gmail.com  │
│                             │
│  剩余积分              0     │
│                             │
│  ┌──────────┐  ┌──────┐    │
│  │充值积分   │  │ 登出 │    │
│  └──────────┘  └──────┘    │
└─────────────────────────────┘
```

---

**准备好测试了吗？** 🎨
