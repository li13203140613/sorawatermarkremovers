# Chrome 扩展 OAuth 登录测试指南

## 📋 准备工作

### 1. 完全卸载旧版本
1. 打开 `chrome://extensions/`
2. 找到 "Sora Video Downloader"
3. 点击 **"移除"** 按钮
4. **关闭所有 Chrome 窗口**
5. 重新打开 Chrome

### 2. 重新加载扩展
1. 打开 `chrome://extensions/`
2. 确保右上角 **"开发者模式"** 已开启
3. 点击 **"加载已解压的扩展程序"**
4. 选择文件夹: `RemoveWM\sora-extension`
5. 确认扩展已加载成功

---

## 🔍 测试步骤

### 第一步:打开 Service Worker 控制台

1. 在 `chrome://extensions/` 页面
2. 找到 "Sora Video Downloader"
3. 点击 **"service worker"** 蓝色链接
4. 会打开 DevTools 控制台窗口
5. **保持这个窗口打开**,用于查看日志

### 第二步:点击扩展图标

1. 点击浏览器右上角的扩展图标
2. 应该看到登录界面,包含:
   - Sora Video Downloader logo
   - "选择登录方式:"
   - "使用 Google 登录" 按钮

### 第三步:点击 Google 登录

1. 点击 **"使用 Google 登录"** 按钮
2. **查看 Service Worker 控制台**,应该看到以下日志:

```
📨 收到消息: {action: 'login', provider: 'google'}
🔐 开始 google OAuth 登录流程 (Implicit Flow)...
📍 Redirect URI: https://[extension-id].chromiumapp.org/
🌐 打开授权窗口...
🔗 OAuth URL: https://zjefhzapfbouslkgllah.supabase.co/auth/v1/authorize?provider=google&redirect_to=https%3A%2F%2F...
```

### 第四步:Google 授权

1. 应该弹出新窗口,显示 Google 登录页面
2. 选择你的 Google 账号
3. 如果是首次登录,需要同意授权

### 第五步:观察重定向行为

**关键观察点**:

授权成功后,查看 Service Worker 控制台,应该看到:

#### ✅ **成功的日志** (期望看到):
```
✅ 授权成功,解析 Token...
📋 完整 Redirect URL: https://[extension-id].chromiumapp.org/#access_token=xxx&refresh_token=yyy&expires_in=3600...
🔍 URL Hash 部分: access_token=xxx&refresh_token=yyy&expires_in=3600...
🔑 Access Token: ✅ 已获取
🔑 Refresh Token: ✅ 已获取
⏱️ Expires In: 3600 秒
💾 Token 已存储
⏰ Token 过期时间: 2025-10-14 ...
📡 获取用户信息...
✅ 用户信息获取成功
✅ 登录成功: your-email@gmail.com
📤 发送登录响应: {success: true, user: {...}}
```

#### ❌ **失败的日志** (如果看到这些):
```
❌ URL 中没有 hash 部分!
💡 尝试检查 query string...
Query params: {code: 'xxx', ...}  ← 说明返回的是 code,不是 token
```

或者:
```
❌ 未获取到 access_token
```

### 第六步:验证登录成功

1. **授权窗口应该自动关闭**
2. 扩展 popup 应该显示:
   - 用户头像或首字母
   - 用户邮箱
   - 积分数量
   - "充值积分" 和 "登出" 按钮

---

## 🐛 故障排查

### 问题1: 授权后没有自动关闭窗口

**可能原因**:
- Supabase 返回的不是 token,而是 code
- redirect URI 配置有问题

**排查方法**:
1. 查看 Service Worker 控制台的 "完整 Redirect URL"
2. 检查 URL 是跳转到网站还是扩展 URI
3. 如果跳转到网站,说明 `redirect_to` 参数没生效

### 问题2: 控制台显示 "URL 中没有 hash 部分"

**可能原因**:
- Supabase 使用了 PKCE flow,返回 code 在 query string
- 不是 Implicit flow

**排查方法**:
1. 查看控制台打印的 "Query params"
2. 如果有 `code` 参数,说明是 PKCE flow
3. 需要检查 Supabase Site URL 配置

### 问题3: "未获取到 access_token"

**可能原因**:
- Token 在 URL hash 中,但参数名不对
- Token 格式异常

**排查方法**:
1. 查看 "🔍 URL Hash 部分" 的完整内容
2. 手动解析看是否有 `access_token` 字段

---

## 📊 关键检查点

### Supabase 配置

1. **Redirect URLs** 必须包含:
   ```
   https://[你的扩展ID].chromiumapp.org/
   ```
   ⚠️ 注意末尾的斜杠 `/`

2. **Site URL** 应该是:
   ```
   https://www.sora-prompt.io
   ```

3. **Google OAuth Provider** 已启用

### Google Cloud Console 配置

1. **已获授权的重定向 URI** 必须包含:
   ```
   https://[你的扩展ID].chromiumapp.org/
   ```

2. **已获授权的 JavaScript 来源** (可选)

---

## 📝 测试结果报告

请将以下信息发给我:

### 1. Service Worker 完整日志
从 "📨 收到消息" 开始到登录完成或失败的所有日志

### 2. 关键信息
- ✅ 或 ❌ 授权窗口是否自动关闭?
- ✅ 或 ❌ 扩展是否显示用户信息?
- 📋 完整的 Redirect URL (如果有)
- 🔍 URL Hash 部分的内容 (如果有)

### 3. 截图
- Service Worker 控制台
- 扩展 popup 界面
- 任何错误提示

---

## ✅ 预期结果

**完整成功的流程**:
1. 点击登录 → 打开 Google 授权窗口
2. 选择账号 → 授权成功
3. 窗口自动关闭 → 扩展显示 "登录中..."
4. 1-2秒后 → 扩展显示用户信息
5. 可以看到用户邮箱和积分

**整个过程应该在 5-10 秒内完成**
