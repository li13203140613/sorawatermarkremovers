# ä»£ç è´¨é‡ä¸ä¼˜åŒ–å»ºè®®

**åˆ†ææ—¥æœŸ**: 2025-10-21
**é¡¹ç›®**: RemoveWM - Sora2 è§†é¢‘å¤„ç†å¹³å°
**ä»£ç è¡Œæ•°**: ~15,000 è¡Œï¼ˆä¸å« node_modulesï¼‰

---

## ğŸ“‹ æ‰§è¡Œæ‘˜è¦

åŸºäºå¯¹æ•´ä¸ªä»£ç åº“çš„æ·±å…¥å®¡æŸ¥ï¼Œæˆ‘æå‡ºäº† **20+æ¡ä¼˜åŒ–å»ºè®®**ï¼Œæ¶µç›–**æ€§èƒ½ä¼˜åŒ–ã€å®‰å…¨åŠ å›ºã€ä»£ç è´¨é‡æå‡ã€ç”¨æˆ·ä½“éªŒæ”¹è¿›**å››å¤§æ–¹é¢ã€‚å®æ–½è¿™äº›å»ºè®®å°†æ˜¾è‘—æå‡é¡¹ç›®çš„æ•´ä½“è´¨é‡å’Œå¯ç»´æŠ¤æ€§ã€‚

### å…³é”®æŒ‡æ ‡
- ğŸ¯ è¯†åˆ«å‡º **5ä¸ªæ€§èƒ½ç“¶é¢ˆ**
- ğŸ”’ å‘ç° **3ä¸ªå®‰å…¨éšæ‚£**
- ğŸ’¡ æå‡º **12ä¸ªä»£ç è´¨é‡æ”¹è¿›ç‚¹**
- âœ¨ å»ºè®® **8ä¸ªç”¨æˆ·ä½“éªŒä¼˜åŒ–**

---

## ğŸš€ æ€§èƒ½ä¼˜åŒ–å»ºè®®

### 1ï¸âƒ£ **æ•°æ®åº“æŸ¥è¯¢ä¼˜åŒ–** (ä¼˜å…ˆçº§: â­â­â­â­â­)

#### é—®é¢˜ä½ç½®
`lib/admin/queries.ts` - `getUsers()` å‡½æ•°

#### é—®é¢˜æè¿°
```typescript
// âŒ å½“å‰å®ç°ï¼šN+1 æŸ¥è¯¢é—®é¢˜
const usersWithStats = await Promise.all(
  (profiles || []).map(async (profile) => {
    // ä¸ºæ¯ä¸ªç”¨æˆ·å•ç‹¬æŸ¥è¯¢ä½¿ç”¨æ¬¡æ•°
    const { count: usageCount } = await supabase
      .from('usage_logs')
      .select('*', { count: 'exact', head: true })
      .eq('user_id', profile.id);

    // ä¸ºæ¯ä¸ªç”¨æˆ·å•ç‹¬æŸ¥è¯¢æœ€åä½¿ç”¨æ—¶é—´
    const { data: lastLog } = await supabase
      .from('usage_logs')
      .select('created_at')
      .eq('user_id', profile.id)
      .order('created_at', { ascending: false })
      .limit(1)
      .single();
    // ...
  })
);
```

**æ€§èƒ½å½±å“**: å¦‚æœæœ‰ 100 ä¸ªç”¨æˆ·ï¼Œä¼šæ‰§è¡Œ 200+ æ¬¡æ•°æ®åº“æŸ¥è¯¢ï¼

#### ä¼˜åŒ–æ–¹æ¡ˆ
```typescript
// âœ… ä¼˜åŒ–åï¼šä½¿ç”¨ JOIN æˆ–èšåˆæŸ¥è¯¢
export async function getUsers(page = 1, limit = 20): Promise<UsersResponse> {
  const supabase = createAdminClient();

  // ä½¿ç”¨ PostgreSQL çš„èšåˆå‡½æ•°
  const { data, error } = await supabase.rpc('get_users_with_stats', {
    page_num: page,
    page_size: limit,
  });

  return {
    users: data || [],
    total: data?.[0]?.total_count || 0,
  };
}

// åœ¨ Supabase ä¸­åˆ›å»ºä¼˜åŒ–çš„ RPC å‡½æ•°
CREATE OR REPLACE FUNCTION get_users_with_stats(page_num INT, page_size INT)
RETURNS TABLE (
  id UUID,
  email TEXT,
  credits INT,
  total_usage BIGINT,
  last_used TIMESTAMP
) AS $$
BEGIN
  RETURN QUERY
  SELECT
    up.id,
    up.email,
    up.credits,
    COUNT(ul.id) AS total_usage,
    MAX(ul.created_at) AS last_used
  FROM user_profiles up
  LEFT JOIN usage_logs ul ON up.id = ul.user_id
  GROUP BY up.id, up.email, up.credits
  ORDER BY up.created_at DESC
  LIMIT page_size OFFSET (page_num - 1) * page_size;
END;
$$ LANGUAGE plpgsql;
```

**é¢„æœŸæ”¶ç›Š**: æŸ¥è¯¢æ—¶é—´ä» 2-5ç§’ é™è‡³ <100ms

---

### 2ï¸âƒ£ **è§†é¢‘è½®è¯¢ä¼˜åŒ–** (ä¼˜å…ˆçº§: â­â­â­â­)

#### é—®é¢˜ä½ç½®
`components/video-generation/VideoGenerator.tsx`

#### é—®é¢˜æè¿°
- å›ºå®š 6 ç§’è½®è¯¢ï¼Œæ— è®ºä»»åŠ¡çŠ¶æ€å¦‚ä½•
- æ²¡æœ‰ä½¿ç”¨ WebSocket å®æ—¶æ¨é€
- è½®è¯¢é—´éš”ä¸æ™ºèƒ½

#### ä¼˜åŒ–æ–¹æ¡ˆ

**æ–¹æ¡ˆA: æ™ºèƒ½è½®è¯¢é—´éš”**
```typescript
// æ ¹æ®ä»»åŠ¡çŠ¶æ€è°ƒæ•´è½®è¯¢é—´éš”
const getPollingInterval = (status: string, progress: number): number => {
  if (status === 'pending') return 10000; // 10ç§’
  if (progress < 30) return 8000; // 8ç§’
  if (progress < 70) return 5000; // 5ç§’
  return 3000; // 3ç§’ï¼ˆæ¥è¿‘å®Œæˆæ—¶æ›´é¢‘ç¹ï¼‰
};

const startPolling = (id: string) => {
  const poll = async () => {
    const response = await fetch(`/api/video-generation/status/${id}`);
    const data = await response.json();

    setTaskStatus(data);

    if (data.status === 'completed' || data.status === 'failed') {
      return; // åœæ­¢è½®è¯¢
    }

    // åŠ¨æ€è°ƒæ•´ä¸‹æ¬¡è½®è¯¢æ—¶é—´
    const interval = getPollingInterval(data.status, data.progress?.progress_pct || 0);
    setTimeout(poll, interval);
  };

  poll();
};
```

**æ–¹æ¡ˆB: ä½¿ç”¨ Server-Sent Events (SSE)**
```typescript
// app/api/video-generation/stream/[taskId]/route.ts
export async function GET(request: Request, { params }: { params: { taskId: string } }) {
  const encoder = new TextEncoder();

  const stream = new ReadableStream({
    async start(controller) {
      const sendUpdate = (data: any) => {
        controller.enqueue(encoder.encode(`data: ${JSON.stringify(data)}\n\n`));
      };

      // è½®è¯¢ä»»åŠ¡çŠ¶æ€å¹¶æ¨é€æ›´æ–°
      const intervalId = setInterval(async () => {
        const status = await checkTaskStatus(params.taskId);
        sendUpdate(status);

        if (status.status === 'completed' || status.status === 'failed') {
          clearInterval(intervalId);
          controller.close();
        }
      }, 3000);
    },
  });

  return new Response(stream, {
    headers: {
      'Content-Type': 'text/event-stream',
      'Cache-Control': 'no-cache',
      'Connection': 'keep-alive',
    },
  });
}

// å®¢æˆ·ç«¯ä½¿ç”¨
useEffect(() => {
  const eventSource = new EventSource(`/api/video-generation/stream/${taskId}`);

  eventSource.onmessage = (event) => {
    const data = JSON.parse(event.data);
    setTaskStatus(data);
  };

  return () => eventSource.close();
}, [taskId]);
```

**é¢„æœŸæ”¶ç›Š**:
- å‡å°‘ä¸å¿…è¦çš„ API è°ƒç”¨ 40%
- æ›´å®æ—¶çš„çŠ¶æ€æ›´æ–°
- æ›´å¥½çš„ç”¨æˆ·ä½“éªŒ

---

### 3ï¸âƒ£ **å›¾ç‰‡ä¼˜åŒ–** (ä¼˜å…ˆçº§: â­â­â­â­)

#### é—®é¢˜æè¿°
- ä½¿ç”¨æ™®é€šçš„ `<img>` æ ‡ç­¾è€Œé `next/image`
- æ²¡æœ‰å›¾ç‰‡æ‡’åŠ è½½
- Base64 å›¾ç‰‡ç›´æ¥ä¼ è¾“ï¼Œä½“ç§¯å¤§

#### ä¼˜åŒ–ä½ç½®
- `components/prompt/PromptCard.tsx`
- `components/blog/BlogCard.tsx`
- è§†é¢‘ç¼©ç•¥å›¾

#### ä¼˜åŒ–æ–¹æ¡ˆ
```typescript
// âŒ Before
<img src={imageUrl} alt="preview" />

// âœ… After
import Image from 'next/image';

<Image
  src={imageUrl}
  alt="preview"
  width={400}
  height={300}
  loading="lazy"
  placeholder="blur"
  blurDataURL="data:image/jpeg;base64,/9j/4AAQSkZJRg..." // æ¨¡ç³Šå ä½ç¬¦
  quality={85} // å‹ç¼©è´¨é‡
/>
```

**é¢„æœŸæ”¶ç›Š**:
- å›¾ç‰‡åŠ è½½é€Ÿåº¦æå‡ 50%
- è‡ªåŠ¨å“åº”å¼å›¾ç‰‡
- è‡ªåŠ¨ WebP æ ¼å¼è½¬æ¢

---

### 4ï¸âƒ£ **ä»£ç åˆ†å‰²ä¼˜åŒ–** (ä¼˜å…ˆçº§: â­â­â­)

#### é—®é¢˜æè¿°
- å¤§å‹ç»„ä»¶æ²¡æœ‰æ‡’åŠ è½½
- é¦–å±åŠ è½½ JS è¿‡å¤§ï¼ˆ~500KB+ï¼‰

#### ä¼˜åŒ–æ–¹æ¡ˆ
```typescript
// âŒ Before
import { VideoGenerator } from '@/components/video-generation/VideoGenerator';

// âœ… After
import dynamic from 'next/dynamic';

const VideoGenerator = dynamic(
  () => import('@/components/video-generation/VideoGenerator'),
  {
    loading: () => <LoadingSpinner />,
    ssr: false, // å¦‚æœä¸éœ€è¦ SSR
  }
);

// å…¶ä»–å¤§å‹ç»„ä»¶ä¹Ÿåº”è¯¥æ‡’åŠ è½½
const PaymentPackages = dynamic(() => import('@/components/payment/PaymentPackages'));
const AdminDashboard = dynamic(() => import('@/components/admin/Dashboard'));
```

**é¢„æœŸæ”¶ç›Š**:
- é¦–å±åŠ è½½æ—¶é—´å‡å°‘ 30%
- æå‡ Lighthouse åˆ†æ•°

---

### 5ï¸âƒ£ **Supabase è¿æ¥æ± ä¼˜åŒ–** (ä¼˜å…ˆçº§: â­â­â­)

#### é—®é¢˜æè¿°
æ¯æ¬¡ API è¯·æ±‚éƒ½åˆ›å»ºæ–°çš„ Supabase å®¢æˆ·ç«¯

#### ä¼˜åŒ–æ–¹æ¡ˆ
```typescript
// lib/supabase/connection-pool.ts
import { createClient } from '@supabase/supabase-js';

class SupabaseConnectionPool {
  private static instance: SupabaseConnectionPool;
  private clients: Map<string, any> = new Map();
  private readonly MAX_CONNECTIONS = 10;

  static getInstance(): SupabaseConnectionPool {
    if (!this.instance) {
      this.instance = new SupabaseConnectionPool();
    }
    return this.instance;
  }

  getClient(key: string = 'default') {
    if (!this.clients.has(key)) {
      if (this.clients.size >= this.MAX_CONNECTIONS) {
        // ç§»é™¤æœ€æ—©çš„è¿æ¥
        const firstKey = this.clients.keys().next().value;
        this.clients.delete(firstKey);
      }

      this.clients.set(
        key,
        createClient(
          process.env.NEXT_PUBLIC_SUPABASE_URL!,
          process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!
        )
      );
    }

    return this.clients.get(key);
  }
}

export const supabasePool = SupabaseConnectionPool.getInstance();
```

---

## ğŸ”’ å®‰å…¨åŠ å›ºå»ºè®®

### 6ï¸âƒ£ **ç¯å¢ƒå˜é‡éªŒè¯** (ä¼˜å…ˆçº§: â­â­â­â­â­)

#### é—®é¢˜æè¿°
ç¼ºå°‘ç¯å¢ƒå˜é‡è¿è¡Œæ—¶éªŒè¯ï¼Œå¯èƒ½å¯¼è‡´ç”Ÿäº§ç¯å¢ƒå´©æºƒ

#### ä¼˜åŒ–æ–¹æ¡ˆ
```typescript
// lib/env.ts
import { z } from 'zod';

const envSchema = z.object({
  NEXT_PUBLIC_SUPABASE_URL: z.string().url(),
  NEXT_PUBLIC_SUPABASE_ANON_KEY: z.string().min(1),
  SUPABASE_SERVICE_ROLE_KEY: z.string().min(1),
  SORA_API_URL: z.string().url(),
  SORA_API_KEY: z.string().min(1),
  STRIPE_SECRET_KEY: z.string().startsWith('sk_'),
  STRIPE_WEBHOOK_SECRET: z.string().startsWith('whsec_'),
  AICODING_API_KEY: z.string().min(1),
});

export function validateEnv() {
  try {
    envSchema.parse(process.env);
    console.log('âœ… ç¯å¢ƒå˜é‡éªŒè¯é€šè¿‡');
  } catch (error) {
    console.error('âŒ ç¯å¢ƒå˜é‡éªŒè¯å¤±è´¥:', error);
    throw new Error('Missing or invalid environment variables');
  }
}

// åœ¨ app å¯åŠ¨æ—¶è°ƒç”¨
// next.config.js
validateEnv();
```

---

### 7ï¸âƒ£ **API é€Ÿç‡é™åˆ¶** (ä¼˜å…ˆçº§: â­â­â­â­â­)

#### é—®é¢˜æè¿°
API ç«¯ç‚¹æ²¡æœ‰é€Ÿç‡é™åˆ¶ï¼Œå®¹æ˜“è¢«æ»¥ç”¨

#### ä¼˜åŒ–æ–¹æ¡ˆ
```typescript
// lib/rate-limit.ts
import { LRUCache } from 'lru-cache';

type RateLimitOptions = {
  interval: number; // æ—¶é—´çª—å£ï¼ˆæ¯«ç§’ï¼‰
  uniqueTokenPerInterval: number; // æœ€å¤§ä»¤ç‰Œæ•°
};

export function rateLimit(options: RateLimitOptions) {
  const tokenCache = new LRUCache({
    max: options.uniqueTokenPerInterval || 500,
    ttl: options.interval || 60000,
  });

  return {
    check: (limit: number, token: string): { success: boolean; remaining: number } => {
      const tokenCount = (tokenCache.get(token) as number[]) || [0];
      if (tokenCount[0] === 0) {
        tokenCache.set(token, tokenCount);
      }

      tokenCount[0] += 1;

      const currentUsage = tokenCount[0];
      const isRateLimited = currentUsage > limit;

      return {
        success: !isRateLimited,
        remaining: limit - currentUsage,
      };
    },
  };
}

// ä½¿ç”¨
const limiter = rateLimit({
  interval: 60 * 1000, // 1åˆ†é’Ÿ
  uniqueTokenPerInterval: 500,
});

export async function POST(request: Request) {
  const ip = request.headers.get('x-forwarded-for') || 'unknown';
  const { success, remaining } = limiter.check(10, ip); // æ¯åˆ†é’Ÿæœ€å¤š10æ¬¡

  if (!success) {
    return NextResponse.json(
      { error: 'è¯·æ±‚è¿‡äºé¢‘ç¹ï¼Œè¯·ç¨åå†è¯•' },
      { status: 429, headers: { 'X-RateLimit-Remaining': String(remaining) } }
    );
  }

  // æ­£å¸¸å¤„ç†
}
```

---

### 8ï¸âƒ£ **è¾“å…¥éªŒè¯ä¸æ¸…ç†** (ä¼˜å…ˆçº§: â­â­â­â­)

#### é—®é¢˜æè¿°
ç”¨æˆ·è¾“å…¥æ²¡æœ‰å……åˆ†éªŒè¯ï¼Œå­˜åœ¨ XSS å’Œæ³¨å…¥é£é™©

#### ä¼˜åŒ–æ–¹æ¡ˆ
```typescript
// lib/validation/schemas.ts
import { z } from 'zod';

export const videoProcessSchema = z.object({
  shareLink: z
    .string()
    .url()
    .refine((url) => url.includes('sora.chatgpt.com'), {
      message: 'æ— æ•ˆçš„ Sora é“¾æ¥',
    }),
  visitorId: z.string().uuid().optional(),
  turnstileToken: z.string().min(1).optional(),
});

export const videoGenerationSchema = z.object({
  model: z.enum(['sora2', 'sora2-unwm']),
  prompt: z
    .string()
    .min(10, 'æç¤ºè¯è‡³å°‘10ä¸ªå­—ç¬¦')
    .max(500, 'æç¤ºè¯æœ€å¤š500ä¸ªå­—ç¬¦')
    .refine((prompt) => !prompt.includes('<script>'), {
      message: 'æç¤ºè¯åŒ…å«éæ³•å­—ç¬¦',
    }),
  images: z.array(z.string()).max(1).optional(),
  creditsToConsume: z.number().int().positive(),
});

// åœ¨ API è·¯ç”±ä¸­ä½¿ç”¨
export async function POST(request: Request) {
  try {
    const body = await request.json();
    const validated = videoProcessSchema.parse(body);

    // ä½¿ç”¨éªŒè¯åçš„æ•°æ®
    const result = await processVideo(validated.shareLink, ...);
    // ...
  } catch (error) {
    if (error instanceof z.ZodError) {
      return NextResponse.json(
        { error: 'å‚æ•°éªŒè¯å¤±è´¥', details: error.errors },
        { status: 400 }
      );
    }
    // ...
  }
}
```

---

## ğŸ’¡ ä»£ç è´¨é‡æå‡

### 9ï¸âƒ£ **TypeScript ä¸¥æ ¼æ¨¡å¼** (ä¼˜å…ˆçº§: â­â­â­â­)

#### å½“å‰é…ç½®
```json
// tsconfig.json
{
  "compilerOptions": {
    "strict": false, // âŒ ä¸å¤Ÿä¸¥æ ¼
    "noImplicitAny": true,
    "strictNullChecks": false // âŒ å­˜åœ¨ null/undefined é£é™©
  }
}
```

#### å»ºè®®é…ç½®
```json
{
  "compilerOptions": {
    "strict": true,
    "noImplicitAny": true,
    "strictNullChecks": true,
    "strictFunctionTypes": true,
    "strictBindCallApply": true,
    "strictPropertyInitialization": true,
    "noImplicitThis": true,
    "alwaysStrict": true,
    "noUnusedLocals": true,
    "noUnusedParameters": true,
    "noImplicitReturns": true,
    "noFallthroughCasesInSwitch": true
  }
}
```

---

### ğŸ”Ÿ **é”™è¯¯è¾¹ç•Œ** (ä¼˜å…ˆçº§: â­â­â­â­)

#### é—®é¢˜æè¿°
ç¼ºå°‘å…¨å±€é”™è¯¯è¾¹ç•Œï¼Œç»„ä»¶å´©æºƒä¼šå¯¼è‡´æ•´ä¸ªåº”ç”¨ç™½å±

#### ä¼˜åŒ–æ–¹æ¡ˆ
```typescript
// components/ErrorBoundary.tsx
'use client';

import React from 'react';

interface ErrorBoundaryProps {
  children: React.ReactNode;
  fallback?: React.ReactNode;
}

interface ErrorBoundaryState {
  hasError: boolean;
  error: Error | null;
}

export class ErrorBoundary extends React.Component<ErrorBoundaryProps, ErrorBoundaryState> {
  constructor(props: ErrorBoundaryProps) {
    super(props);
    this.state = { hasError: false, error: null };
  }

  static getDerivedStateFromError(error: Error): ErrorBoundaryState {
    return { hasError: true, error };
  }

  componentDidCatch(error: Error, errorInfo: React.ErrorInfo) {
    console.error('ErrorBoundary caught:', error, errorInfo);

    // å‘é€åˆ°é”™è¯¯è¿½è¸ªæœåŠ¡ï¼ˆå¦‚ Sentryï¼‰
    if (process.env.NODE_ENV === 'production') {
      // Sentry.captureException(error);
    }
  }

  render() {
    if (this.state.hasError) {
      return (
        this.props.fallback || (
          <div className="min-h-screen flex items-center justify-center bg-gray-50">
            <div className="text-center">
              <h1 className="text-4xl font-bold text-gray-800 mb-4">å‡ºé”™äº†</h1>
              <p className="text-gray-600 mb-6">{this.state.error?.message}</p>
              <button
                onClick={() => window.location.reload()}
                className="px-6 py-3 bg-indigo-600 text-white rounded-lg"
              >
                åˆ·æ–°é¡µé¢
              </button>
            </div>
          </div>
        )
      );
    }

    return this.props.children;
  }
}

// app/layout.tsx
export default function RootLayout({ children }) {
  return (
    <html>
      <body>
        <ErrorBoundary>
          {children}
        </ErrorBoundary>
      </body>
    </html>
  );
}
```

---

### 1ï¸âƒ£1ï¸âƒ£ **æ—¥å¿—ç³»ç»Ÿ** (ä¼˜å…ˆçº§: â­â­â­)

#### é—®é¢˜æè¿°
åˆ°å¤„ä½¿ç”¨ `console.log`ï¼Œç”Ÿäº§ç¯å¢ƒæ—¥å¿—æ··ä¹±

#### ä¼˜åŒ–æ–¹æ¡ˆ
```typescript
// lib/logger.ts
enum LogLevel {
  DEBUG = 0,
  INFO = 1,
  WARN = 2,
  ERROR = 3,
}

class Logger {
  private level: LogLevel;

  constructor() {
    this.level =
      process.env.NODE_ENV === 'production' ? LogLevel.WARN : LogLevel.DEBUG;
  }

  private log(level: LogLevel, message: string, ...args: any[]) {
    if (level < this.level) return;

    const timestamp = new Date().toISOString();
    const prefix = `[${timestamp}] [${LogLevel[level]}]`;

    switch (level) {
      case LogLevel.DEBUG:
        console.debug(prefix, message, ...args);
        break;
      case LogLevel.INFO:
        console.info(prefix, message, ...args);
        break;
      case LogLevel.WARN:
        console.warn(prefix, message, ...args);
        break;
      case LogLevel.ERROR:
        console.error(prefix, message, ...args);
        // å‘é€åˆ°é”™è¯¯è¿½è¸ªæœåŠ¡
        break;
    }
  }

  debug(message: string, ...args: any[]) {
    this.log(LogLevel.DEBUG, message, ...args);
  }

  info(message: string, ...args: any[]) {
    this.log(LogLevel.INFO, message, ...args);
  }

  warn(message: string, ...args: any[]) {
    this.log(LogLevel.WARN, message, ...args);
  }

  error(message: string, ...args: any[]) {
    this.log(LogLevel.ERROR, message, ...args);
  }
}

export const logger = new Logger();

// ä½¿ç”¨
// âŒ console.log('User logged in', user.id);
// âœ… logger.info('User logged in', { userId: user.id });
```

---

### 1ï¸âƒ£2ï¸âƒ£ **å•å…ƒæµ‹è¯•** (ä¼˜å…ˆçº§: â­â­â­â­)

#### é—®é¢˜æè¿°
é¡¹ç›®ç¼ºå°‘å•å…ƒæµ‹è¯•ï¼Œé‡æ„é£é™©é«˜

#### å»ºè®®æ–¹æ¡ˆ
```bash
# å®‰è£…æµ‹è¯•æ¡†æ¶
npm install --save-dev vitest @testing-library/react @testing-library/jest-dom
```

```typescript
// lib/video/__tests__/service.test.ts
import { describe, it, expect, vi } from 'vitest';
import { processVideo } from '../service';

describe('processVideo', () => {
  it('should process video with valid link', async () => {
    const result = await processVideo(
      'https://sora.chatgpt.com/p/test',
      'user-id'
    );

    expect(result.success).toBe(true);
    expect(result.videoUrl).toBeDefined();
  });

  it('should reject invalid link', async () => {
    const result = await processVideo('https://invalid.com', 'user-id');

    expect(result.success).toBe(false);
    expect(result.error).toContain('æ— æ•ˆçš„');
  });

  it('should check credits before processing', async () => {
    // Mock Supabase æŸ¥è¯¢
    const mockSupabase = {
      from: vi.fn().mockReturnThis(),
      select: vi.fn().mockReturnThis(),
      eq: vi.fn().mockReturnThis(),
      single: vi.fn().mockResolvedValue({
        data: { credits: 0 },
        error: null,
      }),
    };

    const result = await processVideo('https://sora.chatgpt.com/p/test', 'user-id');

    expect(result.success).toBe(false);
    expect(result.error).toContain('ç§¯åˆ†ä¸è¶³');
  });
});
```

**å»ºè®®æµ‹è¯•è¦†ç›–ç‡ç›®æ ‡**: 60%+ (æ ¸å¿ƒä¸šåŠ¡é€»è¾‘ 80%+)

---

## âœ¨ ç”¨æˆ·ä½“éªŒä¼˜åŒ–

### 1ï¸âƒ£3ï¸âƒ£ **ç¦»çº¿æ”¯æŒ** (ä¼˜å…ˆçº§: â­â­â­)

#### ä¼˜åŒ–æ–¹æ¡ˆ
```typescript
// app/manifest.ts
export default function manifest() {
  return {
    name: 'RemoveWM - Soraè§†é¢‘å»æ°´å°',
    short_name: 'RemoveWM',
    description: 'Sora2 è§†é¢‘å»æ°´å°ä¸AIè§†é¢‘ç”Ÿæˆå¹³å°',
    start_url: '/',
    display: 'standalone',
    background_color: '#ffffff',
    theme_color: '#6366f1',
    icons: [
      {
        src: '/icon-192.png',
        sizes: '192x192',
        type: 'image/png',
      },
      {
        src: '/icon-512.png',
        sizes: '512x512',
        type: 'image/png',
      },
    ],
  };
}

// æ·»åŠ  Service Worker
// public/sw.js
self.addEventListener('install', (event) => {
  event.waitUntil(
    caches.open('v1').then((cache) => {
      return cache.addAll([
        '/',
        '/styles/globals.css',
        // å…¶ä»–é™æ€èµ„æº
      ]);
    })
  );
});
```

---

### 1ï¸âƒ£4ï¸âƒ£ **éª¨æ¶å±åŠ è½½** (ä¼˜å…ˆçº§: â­â­â­)

#### å½“å‰é—®é¢˜
åŠ è½½æ—¶æ˜¾ç¤ºç©ºç™½ï¼Œç”¨æˆ·ä½“éªŒå·®

#### ä¼˜åŒ–æ–¹æ¡ˆ
```typescript
// components/common/Skeleton.tsx
export function Skeleton({ className = '' }) {
  return (
    <div className={`animate-pulse bg-gray-200 rounded ${className}`} />
  );
}

export function VideoCardSkeleton() {
  return (
    <div className="bg-white rounded-2xl p-6 shadow-lg">
      <Skeleton className="h-48 w-full mb-4" />
      <Skeleton className="h-6 w-3/4 mb-2" />
      <Skeleton className="h-4 w-1/2" />
    </div>
  );
}

// ä½¿ç”¨
<Suspense fallback={<VideoCardSkeleton />}>
  <VideoCard />
</Suspense>
```

---

### 1ï¸âƒ£5ï¸âƒ£ **å›½é™…åŒ–æ”¹è¿›** (ä¼˜å…ˆçº§: â­â­)

#### å»ºè®®ä¼˜åŒ–
```typescript
// æ·»åŠ æ›´å¤šè¯­è¨€
export const locales = ['en', 'zh', 'ja', 'ko', 'es', 'fr'] as const;

// è‡ªåŠ¨è¯­è¨€æ£€æµ‹
import { headers } from 'next/headers';

export async function getPreferredLocale() {
  const headersList = await headers();
  const acceptLanguage = headersList.get('accept-language');

  if (acceptLanguage) {
    const preferredLang = acceptLanguage.split(',')[0].split('-')[0];
    if (locales.includes(preferredLang as any)) {
      return preferredLang;
    }
  }

  return defaultLocale;
}
```

---

### 1ï¸âƒ£6ï¸âƒ£ **å¯è®¿é—®æ€§ (A11y)** (ä¼˜å…ˆçº§: â­â­â­)

#### é—®é¢˜æè¿°
ç¼ºå°‘ ARIA æ ‡ç­¾ã€é”®ç›˜å¯¼èˆªæ”¯æŒä¸å®Œå–„

#### ä¼˜åŒ–ç¤ºä¾‹
```typescript
// âŒ Before
<button onClick={handleClick}>
  æäº¤
</button>

// âœ… After
<button
  onClick={handleClick}
  aria-label="æäº¤è§†é¢‘å¤„ç†è¯·æ±‚"
  aria-busy={loading}
  aria-disabled={!hasCredits}
  disabled={loading || !hasCredits}
>
  {loading ? <span role="status">å¤„ç†ä¸­...</span> : 'æäº¤'}
</button>
```

---

## ğŸ“Š æ€§èƒ½ç›‘æ§å»ºè®®

### 1ï¸âƒ£7ï¸âƒ£ **é›†æˆæ€§èƒ½ç›‘æ§**

#### æ¨èå·¥å…·
- **Vercel Analytics** (å†…ç½®)
- **Google Analytics 4**
- **Sentry** (é”™è¯¯è¿½è¸ª)

```typescript
// lib/analytics.ts
export function trackEvent(event: string, properties?: Record<string, any>) {
  if (typeof window !== 'undefined' && window.gtag) {
    window.gtag('event', event, properties);
  }
}

// ä½¿ç”¨
trackEvent('video_processed', {
  video_url: videoUrl,
  processing_time: duration,
  user_credits: credits,
});
```

---

### 1ï¸âƒ£8ï¸âƒ£ **Web Vitals ä¼˜åŒ–**

```typescript
// app/layout.tsx
import { SpeedInsights } from '@vercel/speed-insights/next';
import { Analytics } from '@vercel/analytics/react';

export default function RootLayout({ children }) {
  return (
    <html>
      <body>
        {children}
        <Analytics />
        <SpeedInsights />
      </body>
    </html>
  );
}

// ç›®æ ‡æŒ‡æ ‡
// - LCP (Largest Contentful Paint) < 2.5s
// - FID (First Input Delay) < 100ms
// - CLS (Cumulative Layout Shift) < 0.1
```

---

## ğŸ“‹ ä¼˜åŒ–å®æ–½è®¡åˆ’

### ç¬¬ä¸€é˜¶æ®µï¼ˆ1å‘¨ï¼‰- ç´§æ€¥ä¼˜åŒ–
| ä¼˜åŒ–é¡¹ | ä¼˜å…ˆçº§ | é¢„è®¡å·¥ä½œé‡ | è´Ÿè´£äºº |
|--------|--------|----------|--------|
| æ•°æ®åº“æŸ¥è¯¢ä¼˜åŒ– | P0 | 1å¤© | åç«¯å¼€å‘ |
| ç¯å¢ƒå˜é‡éªŒè¯ | P0 | 2å°æ—¶ | DevOps |
| API é€Ÿç‡é™åˆ¶ | P0 | 4å°æ—¶ | åç«¯å¼€å‘ |
| è¾“å…¥éªŒè¯ | P0 | 1å¤© | å…¨æ ˆå¼€å‘ |

### ç¬¬äºŒé˜¶æ®µï¼ˆ2å‘¨ï¼‰- æ€§èƒ½æå‡
| ä¼˜åŒ–é¡¹ | ä¼˜å…ˆçº§ | é¢„è®¡å·¥ä½œé‡ |
|--------|--------|----------|
| è§†é¢‘è½®è¯¢ä¼˜åŒ– | P1 | 1å¤© |
| å›¾ç‰‡ä¼˜åŒ– | P1 | 2å¤© |
| ä»£ç åˆ†å‰² | P1 | 1å¤© |
| é”™è¯¯è¾¹ç•Œ | P1 | 4å°æ—¶ |

### ç¬¬ä¸‰é˜¶æ®µï¼ˆ3å‘¨ï¼‰- è´¨é‡æå‡
| ä¼˜åŒ–é¡¹ | ä¼˜å…ˆçº§ | é¢„è®¡å·¥ä½œé‡ |
|--------|--------|----------|
| TypeScript ä¸¥æ ¼æ¨¡å¼ | P2 | 3å¤© |
| å•å…ƒæµ‹è¯• | P2 | 5å¤© |
| æ—¥å¿—ç³»ç»Ÿ | P2 | 1å¤© |
| æ€§èƒ½ç›‘æ§ | P2 | 2å¤© |

### ç¬¬å››é˜¶æ®µï¼ˆ4å‘¨ï¼‰- ä½“éªŒä¼˜åŒ–
| ä¼˜åŒ–é¡¹ | ä¼˜å…ˆçº§ | é¢„è®¡å·¥ä½œé‡ |
|--------|--------|----------|
| éª¨æ¶å± | P3 | 2å¤© |
| ç¦»çº¿æ”¯æŒ | P3 | 3å¤© |
| å¯è®¿é—®æ€§ | P3 | 3å¤© |

---

## âœ… éªŒæ”¶æ ‡å‡†

### æ€§èƒ½æŒ‡æ ‡
- [ ] Lighthouse æ€§èƒ½åˆ†æ•° > 90
- [ ] é¦–å±åŠ è½½æ—¶é—´ < 2s
- [ ] API å“åº”æ—¶é—´ < 500ms
- [ ] æ•°æ®åº“æŸ¥è¯¢ä¼˜åŒ– 50%+

### å®‰å…¨æŒ‡æ ‡
- [ ] æ‰€æœ‰ API æœ‰é€Ÿç‡é™åˆ¶
- [ ] æ‰€æœ‰è¾“å…¥ç»è¿‡éªŒè¯
- [ ] æ— ç¡¬ç¼–ç çš„å¯†é’¥
- [ ] HTTPS å¼ºåˆ¶å¼€å¯

### ä»£ç è´¨é‡
- [ ] TypeScript æ—  `any` ç±»å‹
- [ ] æµ‹è¯•è¦†ç›–ç‡ > 60%
- [ ] ESLint æ— é”™è¯¯
- [ ] æ—  console.log

---

## ğŸ“š æœ€ä½³å®è·µæ¸…å•

### âœ… å¼€å‘è§„èŒƒ
- [ ] ä½¿ç”¨ TypeScript ä¸¥æ ¼æ¨¡å¼
- [ ] æ‰€æœ‰ç»„ä»¶æœ‰ PropTypes æˆ– TypeScript ç±»å‹
- [ ] ä½¿ç”¨ ESLint + Prettier
- [ ] Git commit éµå¾ª Conventional Commits
- [ ] ä»£ç è¯„å®¡å¿…éœ€

### âœ… æ€§èƒ½è§„èŒƒ
- [ ] å›¾ç‰‡ä½¿ç”¨ next/image
- [ ] å¤§ç»„ä»¶ä½¿ç”¨ dynamic import
- [ ] API ä½¿ç”¨ç¼“å­˜ç­–ç•¥
- [ ] æ•°æ®åº“æŸ¥è¯¢æœ‰ç´¢å¼•

### âœ… å®‰å…¨è§„èŒƒ
- [ ] æ‰€æœ‰ç¯å¢ƒå˜é‡éªŒè¯
- [ ] API æœ‰é€Ÿç‡é™åˆ¶
- [ ] ç”¨æˆ·è¾“å…¥ç»è¿‡éªŒè¯
- [ ] å¯†é’¥ä¸æäº¤åˆ° Git

---

**åˆ†æå®Œæˆ**: 2025-10-21
**åˆ†æäºº**: Claude AI
**ç‰ˆæœ¬**: 1.0
**ä¸‹æ¬¡å®¡æŸ¥**: 2025-11-21
